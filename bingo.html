<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>きゃたんのビンゴ抽選</title>

  <link rel="icon" href="IMG_4666.png" type="image/png">
  <meta property="og:image" content="https://www.yourwebsite.com/無題12_20250907003655.jpeg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">

  <link rel="stylesheet" href="common.css">
</head>

<body>
  <div id="header-placeholder"></div>

  <main>
    <section id="bingo">
      <h3>🎉 ビンゴ抽選 🎉</h3>

      <div id="bingoGame">
        <p style="font-size: 1.2rem; margin-bottom: 0.5rem; color: #5aa2aa;">引かれた番号</p>
        <div id="currentNumber">--</div>

        <div class="bingo-buttons-container">
            <button id="drawButton">番号を引く！</button>
            <button id="resetButton">リセット</button>
        </div>

        <h4 style="color: #1b656f; border-bottom: 1px solid #ccc; padding-bottom: 0.3rem; margin-top: 2rem;">すでに引かれた番号一覧</h4>
        <div id="numberBoard">
        </div>
      </div>
    </section>
  </main>

  <div id="footer-placeholder"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <script src="common.js"></script>

  <script>
    // ----------------------------------------------------------------------
    // 🎨 Firebase設定
    // ----------------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
      authDomain: "catiffanygame.firebaseapp.com",
      databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
      projectId: "catiffanygame",
      storageBucket: "catiffanygame.firebasestorage.app",
      messagingSenderId: "166871605809",
      appId: "1:166871605809:web:1fe6e874fa06005ec46b10",
      measurementId: "G-ZNGEZZWMTP"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const bingoRef = db.ref('bingo'); 

    // ----------------------------------------------------------------------
    // ⚙️ ビンゴ抽選ロジック (管理者機能)
    // ----------------------------------------------------------------------
    const maxNumber = 75;
    let availableNumbers = [];
    let drawnNumbers = [];
    let animationInterval = null;
    let isDrawing = false;

    const currentNumberEl = document.getElementById('currentNumber');
    const drawButton = document.getElementById('drawButton');
    const numberBoardEl = document.getElementById('numberBoard');
    const resetButton = document.getElementById('resetButton');
    
    // ヘッダー/ナビゲーション関連のDOM要素は、common.jsの setupHeader が処理するため削除

    function renderBoard(numbers) {
      numberBoardEl.innerHTML = '';
      for (let i = 1; i <= maxNumber; i++) {
        const cell = document.createElement('div');
        cell.className = 'bingo-cell';
        cell.id = `cell-${i}`; 
        cell.setAttribute('data-content', i); 
        
        if (numbers.includes(i)) {
          cell.classList.add('drawn');
        }
        numberBoardEl.appendChild(cell);

        if (i % 10 === 0 && i < maxNumber) {
            const breakEl = document.createElement('div');
            breakEl.className = 'break';
            numberBoardEl.appendChild(breakEl);
        }
      }
    }

    function saveToFirebase(data) {
      bingoRef.update(data).catch(error => {
        console.error("Firebaseへの書き込みに失敗しました:", error);
      });
    }

    function loadGameFromFirebase() {
      bingoRef.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        const storedNumbers = data.drawnNumbers || [];
        const currentDisplay = data.currentDisplay || '--';

        drawnNumbers = storedNumbers;
        const allNumbers = Array.from({ length: maxNumber }, (_, i) => i + 1);
        availableNumbers = allNumbers.filter(n => !drawnNumbers.includes(n));

        currentNumberEl.textContent = currentDisplay;
        drawButton.disabled = false;
        drawButton.textContent = isDrawing ? 'ストップ！' : '番号を引く！';
        
        if (isDrawing) {
            currentNumberEl.classList.add('drawing-mode');
            drawButton.classList.add('drawing-mode');
        } else {
            currentNumberEl.classList.remove('drawing-mode');
            drawButton.classList.remove('drawing-mode');
        }
        
        renderBoard(drawnNumbers);

        if (availableNumbers.length === 0) {
          drawButton.disabled = true;
          drawButton.textContent = 'ゲーム終了';
        } 
      });
    }

    function startAnimation() {
      if (availableNumbers.length === 0) return;

      isDrawing = true;
      drawButton.textContent = 'ストップ！';
      drawButton.classList.add('drawing-mode');
      currentNumberEl.classList.add('drawing-mode');
      currentNumberEl.classList.remove('stop-highlight');

      animationInterval = setInterval(() => {
        const randomIndex = Math.floor(Math.random() * availableNumbers.length);
        if (availableNumbers.length > 0) {
          const displayNum = availableNumbers[randomIndex];
          currentNumberEl.textContent = displayNum;
          
          bingoRef.update({ currentDisplay: displayNum });
        } else {
          stopAndDrawNumber();
        }
      }, 50);
    }

    function stopAndDrawNumber() {
      if (!animationInterval) return;

      clearInterval(animationInterval);
      animationInterval = null;
      isDrawing = false;
      
      if (availableNumbers.length === 0) {
        const finalNum = drawnNumbers[drawnNumbers.length - 1] || '--';
        currentNumberEl.textContent = finalNum;
        saveToFirebase({ currentDisplay: finalNum });
        return;
      }

      const randomIndex = Math.floor(Math.random() * availableNumbers.length);
      const drawnNumber = availableNumbers[randomIndex];

      availableNumbers.splice(randomIndex, 1);
      drawnNumbers.push(drawnNumber);

      saveToFirebase({ 
          drawnNumbers: drawnNumbers, 
          currentDisplay: drawnNumber 
      });

      currentNumberEl.textContent = drawnNumber;
      
      // アニメーションの実行
      currentNumberEl.classList.add('stop-highlight');
      currentNumberEl.classList.remove('drawing-mode');
      
      const finalCell = document.getElementById(`cell-${drawnNumber}`);
      if (finalCell) {
          finalCell.classList.add('stop-flash');
      }

      // アニメーションクラスを解除
      setTimeout(() => {
        currentNumberEl.classList.remove('stop-highlight');
        if (finalCell) {
            finalCell.classList.remove('stop-flash');
        }
        finalCell.classList.add('drawn'); 
      }, 500);

      drawButton.textContent = '次の番号を引く！';
      drawButton.classList.remove('drawing-mode');
    }

    // ----------------------------------------------------------------------
    // 🔌 イベントリスナーと初期化
    // ----------------------------------------------------------------------

    drawButton.addEventListener('click', () => {
      if (availableNumbers.length === 0) {
        return;
      }

      if (!isDrawing) {
        startAnimation();
      } else {
        stopAndDrawNumber();
      }
    });

    resetButton.addEventListener('click', () => {
      if (confirm('ビンゴゲームをリセットしますか？全ての抽選結果が消えます。')) {
        bingoRef.set({ drawnNumbers: [], currentDisplay: '--' });
      }
    });
    
    // ヘッダー/ナビゲーションのイベントリスナーは common.js の setupHeader に移譲されるため削除
    // document.addEventListener("DOMContentLoaded" イベント内で common.js の処理が実行されるため、その後の処理を記述

    document.addEventListener("DOMContentLoaded", () => {
      // ★ 修正: common.js の setupHeader を実行し、管理者ヘッダーを読み込む ★
      setupHeader('header-admin.html'); // 管理者ヘッダーファイルを指定
      
      loadGameFromFirebase(); 
    });
  </script>
</body>

</html>
