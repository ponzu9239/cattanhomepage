<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãã‚ƒãŸã‚“ã®ãƒ“ãƒ³ã‚´æŠ½é¸ä¼šå ´ (ç®¡ç†è€…)</title>

  <link rel="icon" href="IMG_4666.png" type="image/png">
  <meta property="og:image" content="https://www.yourwebsite.com/ç„¡é¡Œ12_20250907003655.jpeg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">

  <link rel="stylesheet" href="common.css">
</head>

<body>
  <div id="header-placeholder"></div>

  <main>
    <section id="bingo">
      <h3>ğŸ‰ ãƒ“ãƒ³ã‚´æŠ½é¸ ğŸ‰</h3>

      <div id="bingoGame">
        <p style="font-size: 1.2rem; margin-bottom: 0.5rem; color: #5aa2aa;">å¼•ã‹ã‚ŒãŸç•ªå·</p>
        <div id="currentNumber">--</div>

        <div class="bingo-buttons-container">
            <button id="drawButton">ç•ªå·ã‚’å¼•ãï¼</button>
            <button id="resetButton">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <h4 style="color: #1b656f; border-bottom: 1px solid #ccc; padding-bottom: 0.3rem; margin-top: 2rem;">ã™ã§ã«å¼•ã‹ã‚ŒãŸç•ªå·ä¸€è¦§ (1ã€œ75)</h4>
        <div id="numberBoard">
        </div>
      </div>
    </section>
  </main>

  <div id="footer-placeholder"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <script src="common.js"></script>

  <script>
    // ----------------------------------------------------------------------
    // ğŸ¨ Firebaseè¨­å®š
    // ----------------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
      authDomain: "catiffanygame.firebaseapp.com",
      databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
      projectId: "catiffanygame",
      storageBucket: "catiffanygame.firebasestorage.app",
      messagingSenderId: "166871605809",
      appId: "1:166871605809:web:1fe6e874fa06005ec46b10",
      measurementId: "G-ZNGEZZWMTP"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const bingoRef = db.ref('bingo'); 

    // ----------------------------------------------------------------------
    // âš™ï¸ ãƒ“ãƒ³ã‚´æŠ½é¸ãƒ­ã‚¸ãƒƒã‚¯ (ç®¡ç†è€…æ©Ÿèƒ½)
    // ----------------------------------------------------------------------
    const maxNumber = 75;
    let availableNumbers = [];
    let drawnNumbers = [];
    let animationInterval = null;
    let isDrawing = false;

    const currentNumberEl = document.getElementById('currentNumber');
    const drawButton = document.getElementById('drawButton');
    const numberBoardEl = document.getElementById('numberBoard');
    const resetButton = document.getElementById('resetButton');

    function renderBoard(numbers) {
      numberBoardEl.innerHTML = '';
      for (let i = 1; i <= maxNumber; i++) {
        const cell = document.createElement('div');
        cell.className = 'bingo-cell';
        cell.id = `cell-${i}`;
        cell.setAttribute('data-content', i); 
        
        if (numbers.includes(i)) {
          cell.classList.add('drawn');
        }
        numberBoardEl.appendChild(cell);

        if (i % 10 === 0 && i < maxNumber) {
            const breakEl = document.createElement('div');
            breakEl.className = 'break';
            numberBoardEl.appendChild(breakEl);
        }
      }
    }

    function saveToFirebase(data) {
      bingoRef.update(data).catch(error => {
        console.error("Firebaseã¸ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
      });
    }

    // Firebaseã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’ç›£è¦–ã—ã€ç”»é¢ã‚’æ›´æ–°
    function loadGameFromFirebase() {
      bingoRef.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        const storedNumbers = data.drawnNumbers || [];
        const currentDisplay = data.currentDisplay || '--';

        drawnNumbers = storedNumbers;
        const allNumbers = Array.from({ length: maxNumber }, (_, i) => i + 1);
        availableNumbers = allNumbers.filter(n => !drawnNumbers.includes(n));

        currentNumberEl.textContent = currentDisplay;
        drawButton.disabled = false;
        drawButton.textContent = isDrawing ? 'ã‚¹ãƒˆãƒƒãƒ—ï¼' : 'ç•ªå·ã‚’å¼•ãï¼';
        
        if (isDrawing) {
            drawButton.classList.add('drawing-mode');
        } else {
            drawButton.classList.remove('drawing-mode');
        }
        
        renderBoard(drawnNumbers);

        if (availableNumbers.length === 0) {
          drawButton.disabled = true;
          drawButton.textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†';
        } 
      });
    }

    // æŠ½é¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
    function startAnimation() {
      if (availableNumbers.length === 0) return;

      isDrawing = true;
      drawButton.textContent = 'ã‚¹ãƒˆãƒƒãƒ—ï¼';
      drawButton.classList.add('drawing-mode');
      currentNumberEl.classList.remove('stop-highlight');

      animationInterval = setInterval(() => {
        const randomIndex = Math.floor(Math.random() * availableNumbers.length);
        if (availableNumbers.length > 0) {
          const displayNum = availableNumbers[randomIndex];
          currentNumberEl.textContent = displayNum;
          
          bingoRef.update({ currentDisplay: displayNum });
        } else {
          stopAndDrawNumber();
        }
      }, 50);
    }

    // æŠ½é¸ã‚’åœæ­¢ã—ã€ç•ªå·ã‚’ç¢ºå®š
    function stopAndDrawNumber() {
      if (!animationInterval) return;

      clearInterval(animationInterval);
      animationInterval = null;
      isDrawing = false;
      
      if (availableNumbers.length === 0) {
        const finalNum = drawnNumbers[drawnNumbers.length - 1] || '--';
        currentNumberEl.textContent = finalNum;
        saveToFirebase({ currentDisplay: finalNum });
        return;
      }

      const randomIndex = Math.floor(Math.random() * availableNumbers.length);
      const drawnNumber = availableNumbers[randomIndex];

      availableNumbers.splice(randomIndex, 1);
      drawnNumbers.push(drawnNumber);

      saveToFirebase({ 
          drawnNumbers: drawnNumbers, 
          currentDisplay: drawnNumber 
      });

      currentNumberEl.textContent = drawnNumber;
      
      // â˜… ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ â˜…
      currentNumberEl.classList.add('stop-highlight');
      
      const finalCell = document.getElementById(`cell-${drawnNumber}`);
      if (finalCell) {
          finalCell.classList.add('stop-flash');
      }

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚’è§£é™¤
      setTimeout(() => {
        currentNumberEl.classList.remove('stop-highlight');
        if (finalCell) {
            finalCell.classList.remove('stop-flash');
        }
      }, 500);

      drawButton.textContent = 'æ¬¡ã®ç•ªå·ã‚’å¼•ãï¼';
      drawButton.classList.remove('drawing-mode');
    }

    // ----------------------------------------------------------------------
    // ğŸ”Œ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¨åˆæœŸåŒ–
    // ----------------------------------------------------------------------

    drawButton.addEventListener('click', () => {
      if (availableNumbers.length === 0) {
        return;
      }

      if (!isDrawing) {
        startAnimation();
      } else {
        stopAndDrawNumber();
      }
    });

    resetButton.addEventListener('click', () => {
      if (confirm('ãƒ“ãƒ³ã‚´ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿå…¨ã¦ã®æŠ½é¸çµæœãŒæ¶ˆãˆã¾ã™ã€‚')) {
        bingoRef.set({ drawnNumbers: [], currentDisplay: '--' });
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      loadGameFromFirebase(); 

      setupHeader('header-admin.html');
    });
  </script>
</body>

</html>
