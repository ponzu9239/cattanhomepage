<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
    // ----------------------------------------------------------------------
    // ğŸ¨ ã‚ãªãŸã®Firebaseè¨­å®š (å¤‰æ›´ãªã—)
    // ----------------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
      authDomain: "catiffanygame.firebaseapp.com",
      databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
      projectId: "catiffanygame",
      storageBucket: "catiffanygame.firebasestorage.app",
      messagingSenderId: "166871605809",
      appId: "1:166871605809:web:1fe6e874fa06005ec46b10",
      measurementId: "G-ZNGEZZWMTP"
    };
    // ----------------------------------------------------------------------

    // FirebaseåˆæœŸåŒ–ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‚ç…§ã®å–å¾—
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    // å‚ç…§ã‚’ /bingo å…¨ä½“ã«å¤‰æ›´
    const bingoRef = db.ref('bingo'); 

    // --- ãƒ“ãƒ³ã‚´ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹å¤‰æ•° ---
    const maxNumber = 75;
    let availableNumbers = []; 
    let drawnNumbers = []; 
    let animationInterval = null; 
    let isDrawing = false; 

    const currentNumberEl = document.getElementById('currentNumber');
    const drawButton = document.getElementById('drawButton');
    const numberBoardEl = document.getElementById('numberBoard');
    const statusMessageEl = document.getElementById('statusMessage');
    const resetButton = document.getElementById('resetButton');

    // ãƒœãƒ¼ãƒ‰ã®æç”»å‡¦ç†
    function renderBoard(numbers) {
      numberBoardEl.innerHTML = '';
      for (let i = 1; i <= maxNumber; i++) {
        const cell = document.createElement('div');
        cell.className = 'bingo-cell';
        cell.id = `cell-${i}`;
        cell.textContent = i;
        if (numbers.includes(i)) {
          cell.classList.add('drawn');
        }
        numberBoardEl.appendChild(cell);
      }
    }

    // æŠ½é¸çµæœã‚’Firebaseã«ä¿å­˜
    function saveToFirebase(data) {
      bingoRef.update(data).catch(error => {
        console.error("Firebaseã¸ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        statusMessageEl.textContent = "âš ï¸ ä¿å­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      });
    }

    // Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ›´æ–°
    function loadGameFromFirebase() {
      // ä¸€åº¦ã ã‘ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦åˆæœŸåŒ–
      bingoRef.once('value', (snapshot) => {
        const data = snapshot.val() || {};
        const storedNumbers = data.drawnNumbers || [];
        const currentDisplay = data.currentDisplay || '--';

        // çŠ¶æ…‹å¤‰æ•°ã‚’æ›´æ–°
        drawnNumbers = storedNumbers;
        const allNumbers = Array.from({ length: maxNumber }, (_, i) => i + 1);
        availableNumbers = allNumbers.filter(n => !drawnNumbers.includes(n));

        // UIã‚’æ›´æ–°
        currentNumberEl.textContent = currentDisplay;
        drawButton.disabled = false;
        drawButton.textContent = 'ç•ªå·ã‚’å¼•ãï¼';
        drawButton.classList.remove('drawing-mode');
        isDrawing = false;
        renderBoard(drawnNumbers);

        if (availableNumbers.length === 0) {
          statusMessageEl.textContent = 'ã™ã¹ã¦ã®ç•ªå·ãŒå‡ºã¾ã—ãŸï¼ã‚²ãƒ¼ãƒ çµ‚äº†ã§ã™ã€‚';
          drawButton.disabled = true;
          drawButton.textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†';
        } else {
          statusMessageEl.textContent = drawnNumbers.length > 0 ? `å‰å›ã®æ•°å­—: ${drawnNumbers[drawnNumbers.length - 1]}` : '';
        }
      });
    }

    // æ•°å­—ã‚’é«˜é€Ÿã§åˆ‡ã‚Šæ›¿ãˆã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    function startAnimation() {
      if (availableNumbers.length === 0) return;

      isDrawing = true;
      drawButton.textContent = 'ã‚¹ãƒˆãƒƒãƒ—ï¼';
      drawButton.classList.add('drawing-mode');

      // 50ãƒŸãƒªç§’ã”ã¨ã«æ•°å­—ã‚’æ›´æ–°ã—ã€Firebaseã«ã‚‚æ›¸ãè¾¼ã‚€
      animationInterval = setInterval(() => {
        const randomIndex = Math.floor(Math.random() * availableNumbers.length);
        if (availableNumbers.length > 0) {
          const displayNum = availableNumbers[randomIndex];
          currentNumberEl.textContent = displayNum;
          
          // â˜… Viewã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åæ˜ ã™ã‚‹ãŸã‚ã€Firebaseã«æ›¸ãè¾¼ã‚€
          bingoRef.update({ currentDisplay: displayNum });
        } else {
          stopAndDrawNumber();
        }
      }, 50);
    }

    // æŠ½é¸ã‚’ç¢ºå®šã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢
    function stopAndDrawNumber() {
      if (!animationInterval) return;

      clearInterval(animationInterval);
      animationInterval = null;
      isDrawing = false;

      if (availableNumbers.length === 0) {
        // ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†
        const finalNum = drawnNumbers[drawnNumbers.length - 1] || '--';
        currentNumberEl.textContent = finalNum;
        statusMessageEl.textContent = 'ã™ã¹ã¦ã®ç•ªå·ãŒå‡ºã¾ã—ãŸï¼ã‚²ãƒ¼ãƒ çµ‚äº†ã§ã™ã€‚';
        drawButton.disabled = true;
        drawButton.textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†';
        drawButton.classList.remove('drawing-mode');
        
        // æœ€çµ‚è¡¨ç¤ºã‚’Firebaseã«ç¢ºå®šã•ã›ã‚‹
        saveToFirebase({ currentDisplay: finalNum });
        return;
      }

      // æœ€çµ‚çš„ãªæŠ½é¸ã‚’è¡Œã†
      const randomIndex = Math.floor(Math.random() * availableNumbers.length);
      const drawnNumber = availableNumbers[randomIndex];

      // é…åˆ—ã‚’æ›´æ–°
      availableNumbers.splice(randomIndex, 1);
      drawnNumbers.push(drawnNumber);

      // --- Firebaseã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ (é‡è¦: ç¢ºå®šç•ªå·ã¨æœ€çµ‚è¡¨ç¤ºã‚’åŒæ™‚ã«æ›´æ–°) ---
      saveToFirebase({ 
          drawnNumbers: drawnNumbers, 
          currentDisplay: drawnNumber 
      });

      // è¡¨ç¤ºã‚’æ›´æ–°
      currentNumberEl.textContent = drawnNumber;
      statusMessageEl.textContent = `ğŸ‰ ${drawnNumbers.length}å€‹ç›®ã®æ•°å­—ã¯ ${drawnNumber} ã§ã™ï¼`;
      drawButton.textContent = 'æ¬¡ã®ç•ªå·ã‚’å¼•ãï¼';
      drawButton.classList.remove('drawing-mode');

      // ãƒœãƒ¼ãƒ‰ä¸Šã®ã‚»ãƒ«ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      renderBoard(drawnNumbers);
      
      if (availableNumbers.length === 0) {
        statusMessageEl.textContent = 'ã™ã¹ã¦ã®ç•ªå·ãŒå‡ºã¾ã—ãŸï¼ã‚²ãƒ¼ãƒ çµ‚äº†ã§ã™ã€‚';
        drawButton.disabled = true;
        drawButton.textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†';
      }
    }

    // ç•ªå·ã‚’å¼•ãå‡¦ç† (ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯)
    drawButton.addEventListener('click', () => {
      if (availableNumbers.length === 0) {
        return;
      }

      if (!isDrawing) {
        startAnimation();
      } else {
        stopAndDrawNumber();
      }
    });

    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®å‡¦ç†
    resetButton.addEventListener('click', () => {
      if (confirm('ãƒ“ãƒ³ã‚´ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿå…¨ã¦ã®æŠ½é¸çµæœãŒæ¶ˆãˆã¾ã™ã€‚')) {
        // Firebaseã®ãƒ‡ãƒ¼ã‚¿ã‚‚ãƒªã‚»ãƒƒãƒˆ
        bingoRef.set({ drawnNumbers: [], currentDisplay: '--' });
        loadGameFromFirebase(); // UIã‚’ãƒªã‚»ãƒƒãƒˆ
      }
    });

    // ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–
    document.addEventListener("DOMContentLoaded", () => {
      loadGameFromFirebase(); // Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã‚²ãƒ¼ãƒ é–‹å§‹

      // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒ­ã‚¸ãƒƒã‚¯
      const hamburger = document.getElementById("hamburger");
      const nav = document.getElementById("nav");

      hamburger.addEventListener("click", () => {
        nav.classList.toggle("show");
      });
    });
</script>