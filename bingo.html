<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
    // ----------------------------------------------------------------------
    // 🎨 あなたのFirebase設定 (変更なし)
    // ----------------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
      authDomain: "catiffanygame.firebaseapp.com",
      databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
      projectId: "catiffanygame",
      storageBucket: "catiffanygame.firebasestorage.app",
      messagingSenderId: "166871605809",
      appId: "1:166871605809:web:1fe6e874fa06005ec46b10",
      measurementId: "G-ZNGEZZWMTP"
    };
    // ----------------------------------------------------------------------

    // Firebase初期化とデータベース参照の取得
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    // 参照を /bingo 全体に変更
    const bingoRef = db.ref('bingo'); 

    // --- ビンゴゲームの状態変数 ---
    const maxNumber = 75;
    let availableNumbers = []; 
    let drawnNumbers = []; 
    let animationInterval = null; 
    let isDrawing = false; 

    const currentNumberEl = document.getElementById('currentNumber');
    const drawButton = document.getElementById('drawButton');
    const numberBoardEl = document.getElementById('numberBoard');
    const statusMessageEl = document.getElementById('statusMessage');
    const resetButton = document.getElementById('resetButton');

    // ボードの描画処理
    function renderBoard(numbers) {
      numberBoardEl.innerHTML = '';
      for (let i = 1; i <= maxNumber; i++) {
        const cell = document.createElement('div');
        cell.className = 'bingo-cell';
        cell.id = `cell-${i}`;
        cell.textContent = i;
        if (numbers.includes(i)) {
          cell.classList.add('drawn');
        }
        numberBoardEl.appendChild(cell);
      }
    }

    // 抽選結果をFirebaseに保存
    function saveToFirebase(data) {
      bingoRef.update(data).catch(error => {
        console.error("Firebaseへの書き込みに失敗しました:", error);
        statusMessageEl.textContent = "⚠️ 保存エラーが発生しました。";
      });
    }

    // Firebaseからデータを読み込み、ゲーム状態を更新
    function loadGameFromFirebase() {
      // 一度だけデータを取得して初期化
      bingoRef.once('value', (snapshot) => {
        const data = snapshot.val() || {};
        const storedNumbers = data.drawnNumbers || [];
        const currentDisplay = data.currentDisplay || '--';

        // 状態変数を更新
        drawnNumbers = storedNumbers;
        const allNumbers = Array.from({ length: maxNumber }, (_, i) => i + 1);
        availableNumbers = allNumbers.filter(n => !drawnNumbers.includes(n));

        // UIを更新
        currentNumberEl.textContent = currentDisplay;
        drawButton.disabled = false;
        drawButton.textContent = '番号を引く！';
        drawButton.classList.remove('drawing-mode');
        isDrawing = false;
        renderBoard(drawnNumbers);

        if (availableNumbers.length === 0) {
          statusMessageEl.textContent = 'すべての番号が出ました！ゲーム終了です。';
          drawButton.disabled = true;
          drawButton.textContent = 'ゲーム終了';
        } else {
          statusMessageEl.textContent = drawnNumbers.length > 0 ? `前回の数字: ${drawnNumbers[drawnNumbers.length - 1]}` : '';
        }
      });
    }

    // 数字を高速で切り替えるアニメーション開始
    function startAnimation() {
      if (availableNumbers.length === 0) return;

      isDrawing = true;
      drawButton.textContent = 'ストップ！';
      drawButton.classList.add('drawing-mode');

      // 50ミリ秒ごとに数字を更新し、Firebaseにも書き込む
      animationInterval = setInterval(() => {
        const randomIndex = Math.floor(Math.random() * availableNumbers.length);
        if (availableNumbers.length > 0) {
          const displayNum = availableNumbers[randomIndex];
          currentNumberEl.textContent = displayNum;
          
          // ★ Viewにリアルタイムで反映するため、Firebaseに書き込む
          bingoRef.update({ currentDisplay: displayNum });
        } else {
          stopAndDrawNumber();
        }
      }, 50);
    }

    // 抽選を確定してアニメーションを停止
    function stopAndDrawNumber() {
      if (!animationInterval) return;

      clearInterval(animationInterval);
      animationInterval = null;
      isDrawing = false;

      if (availableNumbers.length === 0) {
        // ゲーム終了処理
        const finalNum = drawnNumbers[drawnNumbers.length - 1] || '--';
        currentNumberEl.textContent = finalNum;
        statusMessageEl.textContent = 'すべての番号が出ました！ゲーム終了です。';
        drawButton.disabled = true;
        drawButton.textContent = 'ゲーム終了';
        drawButton.classList.remove('drawing-mode');
        
        // 最終表示をFirebaseに確定させる
        saveToFirebase({ currentDisplay: finalNum });
        return;
      }

      // 最終的な抽選を行う
      const randomIndex = Math.floor(Math.random() * availableNumbers.length);
      const drawnNumber = availableNumbers[randomIndex];

      // 配列を更新
      availableNumbers.splice(randomIndex, 1);
      drawnNumbers.push(drawnNumber);

      // --- Firebaseにデータを保存 (重要: 確定番号と最終表示を同時に更新) ---
      saveToFirebase({ 
          drawnNumbers: drawnNumbers, 
          currentDisplay: drawnNumber 
      });

      // 表示を更新
      currentNumberEl.textContent = drawnNumber;
      statusMessageEl.textContent = `🎉 ${drawnNumbers.length}個目の数字は ${drawnNumber} です！`;
      drawButton.textContent = '次の番号を引く！';
      drawButton.classList.remove('drawing-mode');

      // ボード上のセルをハイライト
      renderBoard(drawnNumbers);
      
      if (availableNumbers.length === 0) {
        statusMessageEl.textContent = 'すべての番号が出ました！ゲーム終了です。';
        drawButton.disabled = true;
        drawButton.textContent = 'ゲーム終了';
      }
    }

    // 番号を引く処理 (ボタンクリック)
    drawButton.addEventListener('click', () => {
      if (availableNumbers.length === 0) {
        return;
      }

      if (!isDrawing) {
        startAnimation();
      } else {
        stopAndDrawNumber();
      }
    });

    // リセットボタンの処理
    resetButton.addEventListener('click', () => {
      if (confirm('ビンゴゲームをリセットしますか？全ての抽選結果が消えます。')) {
        // Firebaseのデータもリセット
        bingoRef.set({ drawnNumbers: [], currentDisplay: '--' });
        loadGameFromFirebase(); // UIをリセット
      }
    });

    // ページの読み込み完了時にゲームを初期化
    document.addEventListener("DOMContentLoaded", () => {
      loadGameFromFirebase(); // Firebaseからデータを読み込んでゲーム開始

      // ハンバーガーメニューのロジック
      const hamburger = document.getElementById("hamburger");
      const nav = document.getElementById("nav");

      hamburger.addEventListener("click", () => {
        nav.classList.toggle("show");
      });
    });
</script>