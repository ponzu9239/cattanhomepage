<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI学習型チーム分け</title>
<style>
  body { font-family:"Hiragino Maru Gothic ProN",sans-serif; background:#f7fcfc; margin:0; padding:16px; }
  h1 { text-align:center; color:#47b6a2; font-size:26px; font-weight:800; margin-bottom:12px; }
  .teams { display:flex; flex-direction:column; gap:16px; margin-bottom:16px; align-items:center; }
  .team-box { width:90%; max-width:500px; background:#eefaff; padding:12px; border-radius:12px; border:2px solid #97eadb; text-align:center; }
  .team-box.team2 { background:#fff1f5; border-color:#ffb6c1; }
  .team-box h2 { font-size:18px; margin:0 0 8px 0; color:#47b6a2; }
  .team-box ul { list-style:none; padding:0 8px; margin:0; display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; }
  .team-box li { background:white; border:1.5px solid #ddd; border-radius:8px; padding:6px; font-size:15px; font-weight:500; text-align:center; }
  .player-list { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:12px; margin-bottom:20px; }
  .player { background:#fff; border:2px solid #97eadb; border-radius:10px; padding:10px 6px; text-align:center; cursor:pointer; transition: transform 0.15s, box-shadow 0.15s; position:relative; font-size:14px; }
  .player:hover { transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,0.1); }
  .player.selected { background:#97eadb; color:white; }
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.0.0/dist/tf.min.js"></script>
</head>
<body>

<h1>AI学習型チーム分け</h1>

<div class="teams">
  <div class="team-box team1"><h2>チーム1</h2><ul id="teamA"></ul></div>
  <div class="team-box team2"><h2>チーム2</h2><ul id="teamB"></ul></div>
</div>

<div id="playerList" class="player-list"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBbHLIr4GWkZ3Mfbg3M8wOY68X1ITrE-yw",
  authDomain: "match-result-ea475.firebaseapp.com",
  databaseURL: "https://match-result-ea475-default-rtdb.firebaseio.com",
  projectId: "match-result-ea475",
  storageBucket: "match-result-ea475.appspot.com",
  messagingSenderId: "759877853492",
  appId: "1:759877853492:web:a10935960bf8230afbg3M8wOY68X1ITrE-yw"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let matches = [];
let playerStrength = {};

db.ref("apex_results").once("value").then(snapshot => {
  if(!snapshot.exists()) return;
  matches = Object.values(snapshot.val());
  initPlayers();
  learnPlayerStrength();
}).catch(err=>console.error(err));

function initPlayers(){
  const players = [...new Set(matches.flatMap(m=>[...m.teamA,...m.teamB]))];
  const container = document.getElementById("playerList");
  container.innerHTML="";
  players.forEach(name=>{
    const div = document.createElement("div");
    div.className="player"; div.textContent=name; div.dataset.name=name;
    div.onclick = ()=>{div.classList.toggle("selected"); makeTeams();}
    container.appendChild(div);
  });
}

// TensorFlow.jsでプレイヤー強さ学習
async function learnPlayerStrength(){
  if(!matches.length) return;
  const allPlayers = [...new Set(matches.flatMap(m=>[...m.teamA,...m.teamB]))];
  const nameToIndex = {}; allPlayers.forEach((n,i)=>nameToIndex[n]=i);

  const xs=[], ys=[];
  matches.forEach(m=>{
    const vecA = Array(allPlayers.length).fill(0); m.teamA.forEach(p=>vecA[nameToIndex[p]]=1); xs.push(vecA); ys.push(m.teamAKills);
    const vecB = Array(allPlayers.length).fill(0); m.teamB.forEach(p=>vecB[nameToIndex[p]]=1); xs.push(vecB); ys.push(m.teamBKills);
  });

  const X=tf.tensor2d(xs); const Y=tf.tensor2d(ys,[ys.length,1]);
  const model=tf.sequential(); model.add(tf.layers.dense({inputShape:[allPlayers.length], units:1,useBias:false}));
  model.compile({loss:'meanSquaredError', optimizer:'adam'});
  await model.fit(X,Y,{epochs:200,verbose:0});
  const weights = model.layers[0].getWeights()[0].arraySync();
  allPlayers.forEach((p,i)=>playerStrength[p]=weights[i][0]);
  makeTeams();
}

function makeTeams(){
  const selected = Array.from(document.querySelectorAll(".player.selected")).map(d=>d.dataset.name);
  if(!selected.length) return;
  const scores = selected.map(name=>({name,strength:playerStrength[name]||0}));
  scores.sort((a,b)=>b.strength-a.strength);
  const teamA=[], teamB=[];
  scores.forEach((p,i)=>{ if(i%2===0) teamA.push(p.name); else teamB.push(p.name); });

  document.getElementById("teamA").innerHTML = teamA.map(n=>`<li>${n}</li>`).join("");
  document.getElementById("teamB").innerHTML = teamB.map(n=>`<li>${n}</li>`).join("");
}
</script>

</body>
</html>