<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>きゃたんのAPEXビンゴゲーム</title>
<link rel="stylesheet" href="common.css">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div id="header-placeholder"></div>

<main>
  <section class="bingo-card-section">
    <h1 class="page-title">APEXビンゴチャレンジ</h1>
    <input type="text" id="playerName" placeholder="名前を入力">
    <input type="text" id="numberInput" placeholder="番号を連続で入力(例:123)">
    <h2 id="cardTitle">ビンゴカード</h2>

    <div id="bingoCard" class="bingo-card">
      <!-- 3×3の数字セル -->
    </div>

    <canvas id="bingoLineCanvas"></canvas>

    <div class="timestamp" id="cardTimestamp"></div>

    <div class="buttons">
      <button id="startStopBtn">抽選開始</button>
      <button id="shareBtn">ビンゴカードを共有</button>
    </div>
  </section>
</main>

<div id="footer-placeholder"></div>

<script src="common.js"></script>
<script>
setupHeader('header-user.html');

// Firebase初期化
const firebaseConfig = {
  apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
  authDomain: "catiffanygame.firebaseapp.com",
  databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
  projectId: "catiffanygame",
  storageBucket: "catiffanygame.firebasestorage.app",
  messagingSenderId: "166871605809",
  appId: "1:166871605809:web:1fe6e874fa06005ec46b10",
  measurementId: "G-ZNGEZZWMTP"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const bingoCardRef = db.ref('bingoCard');

const bingoCard = document.getElementById('bingoCard');
const startStopBtn = document.getElementById('startStopBtn');
const shareBtn = document.getElementById('shareBtn');
const playerNameInput = document.getElementById('playerName');
const numberInput = document.getElementById('numberInput');
const cardTitle = document.getElementById('cardTitle');
const cardTimestamp = document.getElementById('cardTimestamp');
const bingoLineCanvas = document.getElementById('bingoLineCanvas');

let intervalId = null;
let currentNumbers = [];

// 3x3セル生成
function createCells() {
  bingoCard.innerHTML = '';
  currentNumbers = shuffleNumbers();
  for (let i = 0; i < 9; i++) {
    const cell = document.createElement('div');
    cell.textContent = currentNumbers[i];
    cell.dataset.number = currentNumbers[i];
    cell.classList.add('bingo-cell');
    bingoCard.appendChild(cell);
  }
  drawBingoLine([]);
}

// ランダム数字
function shuffleNumbers() {
  const nums = [...Array(9)].map((_, i) => i + 1);
  return nums.sort(() => Math.random() - 0.5);
}

// 高速シャッフル
function startShuffle() {
  intervalId = setInterval(() => {
    currentNumbers = shuffleNumbers();
    bingoCard.querySelectorAll('.bingo-cell').forEach((cell,i)=>{
      cell.textContent = currentNumbers[i];
      cell.dataset.number = currentNumbers[i];
      cell.classList.remove('highlight');
    });
    drawBingoLine([]);
  },50);
}

// 停止
function stopShuffle() {
  clearInterval(intervalId);
  intervalId = null;

  const now = new Date();
  const formatted = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  cardTimestamp.textContent = formatted;

  updateHighlights();
  saveToFirebase();
}

// 名前入力でリアルタイムタイトル更新
playerNameInput.addEventListener('input', () => {
  const name = playerNameInput.value.trim();
  cardTitle.textContent = name ? `${name}のカード` : 'ビンゴカード';
});

// 番号入力でハイライト
numberInput.addEventListener('input', updateHighlights);

function updateHighlights() {
  const inputNums = numberInput.value.trim().split('').map(Number);
  const cells = bingoCard.querySelectorAll('.bingo-cell');
  cells.forEach(c => c.classList.remove('highlight'));

  inputNums.forEach(num => {
    cells.forEach(c => {
      if(Number(c.dataset.number)===num) c.classList.add('highlight');
    });
  });

  const bingoPattern = checkBingo(inputNums);
  drawBingoLine(bingoPattern);
}

// ビンゴ判定
function checkBingo(selectedNums){
  const board = [];
  for(let i=0;i<3;i++) board.push([]);
  bingoCard.querySelectorAll('.bingo-cell').forEach((cell,i)=>{
    board[Math.floor(i/3)].push(Number(cell.dataset.number));
  });

  const patterns=[
    [[0,0],[0,1],[0,2]],
    [[1,0],[1,1],[1,2]],
    [[2,0],[2,1],[2,2]],
    [[0,0],[1,0],[2,0]],
    [[0,1],[1,1],[2,1]],
    [[0,2],[1,2],[2,2]],
    [[0,0],[1,1],[2,2]],
    [[0,2],[1,1],[2,0]]
  ];

  for(let p of patterns){
    if(p.every(([r,c])=>selectedNums.includes(board[r][c]))) return p;
  }
  return [];
}

// ビンゴライン描画
function drawBingoLine(pattern){
  const canvas = bingoLineCanvas;
  canvas.width = bingoCard.offsetWidth;
  canvas.height = bingoCard.offsetHeight;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!pattern.length) return;

  ctx.strokeStyle='red';
  ctx.lineWidth=5;
  ctx.lineCap='round';

  const cellW = canvas.width/3;
  const cellH = canvas.height/3;

  const [start,,end]=pattern;
  const startX = start[1]*cellW+cellW/2;
  const startY = start[0]*cellH+cellH/2;
  const endX = end[1]*cellW+cellW/2;
  const endY = end[0]*cellH+cellH/2;

  ctx.beginPath();
  ctx.moveTo(startX,startY);
  ctx.lineTo(endX,endY);
  ctx.stroke();
}

// Firebaseに保存
function saveToFirebase(){
  const name = playerNameInput.value.trim();
  bingoCardRef.set({
    name: name || '名無し',
    numbers: currentNumbers,
    timestamp: cardTimestamp.textContent,
    highlighted: numberInput.value.trim()
  });
}

// 開始/停止ボタン
startStopBtn.addEventListener('click',()=>{
  if(intervalId) stopShuffle();
  else startShuffle();
});

// 初期化
createCells();
</script>
</body>
</html>