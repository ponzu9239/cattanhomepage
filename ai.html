<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ビンゴカード</title>
  <link rel="stylesheet" href="bingo.css">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
      authDomain: "catiffanygame.firebaseapp.com",
      databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
      projectId: "catiffanygame",
      storageBucket: "catiffanygame.firebasestorage.app",
      messagingSenderId: "166871605809",
      appId: "1:166871605809:web:1fe6e874fa06005ec46b10",
      measurementId: "G-ZNGEZZWMTP"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const bingoRef = ref(db, "bingo/numbers");

    const bingoCard = [
      [1, 2, 3, 4, 5],
      [6, 7, 8, 9, 10],
      [11, 12, "FREE", 13, 14],
      [15, 16, 17, 18, 19],
      [20, 21, 22, 23, 24]
    ];

    window.onload = () => {
      const card = document.getElementById("bingo-card");
      bingoCard.forEach(row => {
        row.forEach(num => {
          const cell = document.createElement("div");
          cell.textContent = num;
          cell.classList.add("cell");
          if (num === "FREE") cell.classList.add("free");
          card.appendChild(cell);
        });
      });

      document.getElementById("sendBtn").onclick = () => {
        const input = document.getElementById("numberInput").value;
        const numbers = input.split("").map(n => parseInt(n));
        set(bingoRef, numbers);
      };

      onValue(bingoRef, snapshot => {
        const numbers = snapshot.val() || [];
        highlight(numbers);
        checkBingo(numbers);
      });
    };

    function highlight(numbers) {
      const cells = document.querySelectorAll(".cell");
      cells.forEach(cell => {
        const num = cell.textContent;
        if (numbers.includes(parseInt(num))) {
          cell.classList.add("active");
        } else {
          cell.classList.remove("active");
        }
      });
    }

    function checkBingo(numbers) {
      const lines = [
        [0,1,2,3,4],
        [5,6,7,8,9],
        [10,11,12,13,14],
        [15,16,17,18,19],
        [20,21,22,23,24],
        [0,5,10,15,20],
        [1,6,11,16,21],
        [2,7,12,17,22],
        [3,8,13,18,23],
        [4,9,14,19,24],
      ];
      const cells = document.querySelectorAll(".cell");
      document.querySelectorAll(".line").forEach(l => l.remove());

      lines.forEach(line => {
        const isBingo = line.every(i => {
          const num = bingoCard.flat()[i];
          return num === "FREE" || numbers.includes(num);
        });
        if (isBingo) drawLine(line);
      });
    }

    function drawLine(line) {
      const card = document.getElementById("bingo-card");
      const rect = card.getBoundingClientRect();
      const first = card.children[line[0]].getBoundingClientRect();
      const last = card.children[line[line.length - 1]].getBoundingClientRect();
      const lineEl = document.createElement("div");
      lineEl.classList.add("line");

      const x1 = first.left + first.width / 2 - rect.left;
      const y1 = first.top + first.height / 2 - rect.top;
      const x2 = last.left + last.width / 2 - rect.left;
      const y2 = last.top + last.height / 2 - rect.top;
      const length = Math.hypot(x2 - x1, y2 - y1);
      const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;

      lineEl.style.width = `${length}px`;
      lineEl.style.transform = `rotate(${angle}deg)`;
      lineEl.style.top = `${y1}px`;
      lineEl.style.left = `${x1}px`;
      card.appendChild(lineEl);
    }
  </script>
</head>
<body>
  <h1>ビンゴカード</h1>
  <input id="nameInput" placeholder="サイトの名前を入力">
  <input id="numberInput" placeholder="番号を入力 (例:123)">
  <button id="sendBtn">送信</button>
  <div id="bingo-card"></div>
</body>
</html>