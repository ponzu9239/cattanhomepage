<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãã‚ƒãŸã‚“ã®APEXãƒ“ãƒ³ã‚´</title>
<link rel="stylesheet" href="common.css">
</head>
<body>
  <main>
    <section class="bingo-card-section">
      <h1 class="page-title">APEXãƒ“ãƒ³ã‚´ ğŸ¯</h1>
      <h2 id="cardTitle">ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰</h2>

      <div id="bingoCard" class="bingo-card"></div>
      <div class="timestamp" id="cardTimestamp"></div>
    </section>

    <input type="text" id="numberInput" placeholder="ç•ªå·ã‚’å…¥åŠ›ï¼ˆä¾‹: 123ï¼‰">

    <div class="buttons">
      <button id="startStopBtn">æŠ½é¸é–‹å§‹</button>
      <button id="shareBtn">ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’å…±æœ‰</button>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
      authDomain: "catiffanygame.firebaseapp.com",
      databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
      projectId: "catiffanygame",
      storageBucket: "catiffanygame.firebasestorage.app",
      messagingSenderId: "166871605809",
      appId: "1:166871605809:web:1fe6e874fa06005ec46b10",
      measurementId: "G-ZNGEZZWMTP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const bingoCardRef = db.ref('bingoCard');

    const bingoCard = document.getElementById('bingoCard');
    const startStopBtn = document.getElementById('startStopBtn');
    const shareBtn = document.getElementById('shareBtn');
    const numberInput = document.getElementById('numberInput');
    const cardTitle = document.getElementById('cardTitle');
    const cardTimestamp = document.getElementById('cardTimestamp');

    let intervalId = null;
    let currentNumbers = [];

    function createCells() {
      bingoCard.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement('div');
        bingoCard.appendChild(cell);
      }
    }

    function shuffleNumbers() {
      const numbers = [...Array(9)].map((_, i) => i + 1);
      return numbers.sort(() => Math.random() - 0.5);
    }

    function startShuffle() {
      intervalId = setInterval(() => {
        currentNumbers = shuffleNumbers();
        bingoCard.querySelectorAll('div').forEach((cell, i) => {
          cell.textContent = currentNumbers[i];
          cell.classList.remove('marked');
        });
        removeLine();
      }, 50);
    }

    function stopShuffle() {
      clearInterval(intervalId);
      intervalId = null;

      const now = new Date();
      const formatted = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      cardTimestamp.textContent = formatted;

      bingoCardRef.set({
        numbers: currentNumbers,
        timestamp: formatted
      });
    }

    function removeLine() {
      const line = document.querySelector('.bingo-line');
      if(line) line.remove();
    }

    function checkBingo(indices) {
      const lines = [
        [0,1,2],[3,4,5],[6,7,8], // æ¨ª
        [0,3,6],[1,4,7],[2,5,8], // ç¸¦
        [0,4,8],[2,4,6]           // æ–œã‚
      ];
      return lines.filter(line => line.every(i => indices.includes(i)));
    }

    function drawLine(lineType) {
      removeLine();
      const line = document.createElement('div');
      line.classList.add('bingo-line');
      line.style.position = 'absolute';
      line.style.backgroundColor = 'pink';
      line.style.zIndex = 10;

      // æ¨ª
      if(lineType.type === 'row') {
        line.style.height = '12px';
        line.style.width = `${bingoCard.offsetWidth + 10}px`;
        line.style.top = `${(lineType.index * 100) + 50}px`;
        line.style.left = `0px`;
      }
      // ç¸¦
      else if(lineType.type === 'col') {
        line.style.width = '12px';
        line.style.height = `${bingoCard.offsetHeight + 10}px`;
        line.style.top = `0px`;
        line.style.left = `${(lineType.index * 100) + 50}px`;
      }
      // æ–œã‚
      else if(lineType.type === 'diag') {
        line.style.width = '12px';
        line.style.height = `${Math.sqrt(2)*bingoCard.offsetWidth}px`;
        line.style.top = '0px';
        line.style.left = '50%';
        line.style.transform = lineType.index === 0 ? 'rotate(45deg) translateX(-50%)' : 'rotate(-45deg) translateX(-50%)';
        line.style.transformOrigin = 'top center';
      }

      bingoCard.appendChild(line);
    }

    numberInput.addEventListener('input', () => {
      const inputNumbers = numberInput.value.split('').map(n => parseInt(n)).filter(n => !isNaN(n));
      bingoCard.querySelectorAll('div').forEach((cell, i) => {
        if(inputNumbers.includes(currentNumbers[i])) {
          cell.classList.add('marked'); // æ˜ã‚‹ã„ã‚ªãƒ¬ãƒ³ã‚¸ã«ã™ã‚‹
        } else {
          cell.classList.remove('marked');
        }
      });

      const markedIndices = currentNumbers.map((num, idx) => inputNumbers.includes(num) ? idx : null).filter(idx => idx!==null);
      const bingos = checkBingo(markedIndices);

      bingos.forEach(line => {
        // æ¨ª
        if([0,3,6].includes(line[0])) drawLine({type:'col', index:line[0]%3});
        else if([0,1,2].includes(line[0])) drawLine({type:'row', index:Math.floor(line[0]/3)});
        else drawLine({type:'diag', index: line[0]===0 || line[0]===4?0:1});
      });
    });

    startStopBtn.addEventListener('click', () => {
      if(intervalId) {
        stopShuffle();
        startStopBtn.textContent = 'æŠ½é¸é–‹å§‹';
      } else {
        startShuffle();
        startStopBtn.textContent = 'åœæ­¢';
      }
    });

    shareBtn.addEventListener('click', async () => {
      const element = document.querySelector('.bingo-card-section');
      html2canvas(element).then(canvas => {
        canvas.toBlob(async (blob) => {
          const filesArray = [new File([blob], "bingo-card.png", {type: blob.type})];
          if (navigator.canShare && navigator.canShare({ files: filesArray })) {
            await navigator.share({
              files: filesArray,
              title: cardTitle.textContent,
              text: 'ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’å…±æœ‰ã—ã¾ã™'
            });
          } else {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bingo-card.png';
            a.click();
            URL.revokeObjectURL(url);
          }
        });
      });
    });

    createCells();
  </script>
</body>
</html>