<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãã‚ƒãŸã‚“ã®APEXãƒ“ãƒ³ã‚´</title>
<link rel="stylesheet" href="common.css">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div id="header-placeholder"></div>

<main>
  <section class="bingo-card-section">
    <h1 class="page-title">APEXãƒ“ãƒ³ã‚´ ğŸ¯</h1>
    <h2 id="cardTitle">ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰</h2>

    <div id="bingoCard" class="bingo-card">
      <canvas id="bingoLineCanvas"></canvas>
    </div>

    <div class="timestamp" id="cardTimestamp"></div>
  </section>

  <input type="number" id="numberInput" placeholder="ç•ªå·ã‚’å…¥åŠ›">

  <div class="buttons">
    <button id="startStopBtn">æŠ½é¸é–‹å§‹</button>
    <button id="shareBtn">ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’å…±æœ‰</button>
  </div>
</main>

<div id="footer-placeholder"></div>

<script src="common.js"></script>
<script>
setupHeader('header-user.html');

// Firebase åˆæœŸåŒ–
const firebaseConfig = {
  apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
  authDomain: "catiffanygame.firebaseapp.com",
  databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
  projectId: "catiffanygame",
  storageBucket: "catiffanygame.firebasestorage.app",
  messagingSenderId: "166871605809",
  appId: "1:166871605809:web:1fe6e874fa06005ec46b10",
  measurementId: "G-ZNGEZZWMTP"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const bingoCardRef = db.ref('bingoCard');       
const currentNumbersRef = db.ref('currentNumbers'); 
const markedNumbersRef = db.ref('markedNumbers');   
const timestampRef = db.ref('timestamp');           

const bingoCard = document.getElementById('bingoCard');
const startStopBtn = document.getElementById('startStopBtn');
const shareBtn = document.getElementById('shareBtn');
const numberInput = document.getElementById('numberInput');
const cardTimestamp = document.getElementById('cardTimestamp');
const canvas = document.getElementById('bingoLineCanvas');
const ctx = canvas.getContext('2d');

let intervalId = null;
let currentNumbers = [];
let markedNumbers = [];

function createCells() {
  bingoCard.innerHTML = '';
  for (let i = 0; i < 9; i++) {
    const cell = document.createElement('div');
    cell.classList.add('bingo-cell');
    cell.textContent = '';
    bingoCard.appendChild(cell);
  }
  bingoCard.appendChild(canvas);
  resizeCanvas();
}

function shuffleNumbers() {
  return [...Array(9)].map((_, i) => i + 1).sort(() => Math.random() - 0.5);
}

// æŠ½é¸é–‹å§‹ï¼ˆé«˜é€Ÿã§å…¥ã‚Œæ›¿ã‚ã‚‹ï¼‰
function startShuffle() {
  // å…¥åŠ›æ¬„ãƒªã‚»ãƒƒãƒˆï¼†ç©ºé…åˆ—é€ä¿¡
  numberInput.value = '';
  markedNumbers = [];
  markedNumbersRef.set([]);

  Array.from(bingoCard.querySelectorAll('.bingo-cell')).forEach(cell => {
    cell.classList.remove('highlight');
  });
  clearCanvas();

  intervalId = setInterval(() => {
    currentNumbers = shuffleNumbers();
    bingoCard.querySelectorAll('.bingo-cell').forEach((cell, i) => {
      cell.textContent = currentNumbers[i];
    });
    currentNumbersRef.set(currentNumbers); // æŠ½é¸ä¸­ã®æ•°å­—é€ä¿¡
  }, 50);
}

function stopShuffle() {
  clearInterval(intervalId);
  intervalId = null;

  bingoCard.querySelectorAll('.bingo-cell').forEach((cell, i) => {
    cell.textContent = currentNumbers[i];