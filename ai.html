<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>„Åç„ÇÉ„Åü„Çì„ÅÆAPEX„Éì„É≥„Ç¥</title>
<link rel="stylesheet" href="common.css">
<style>
  body {
    background-color: #97eadb;
    font-family: 'Arial', sans-serif;
    text-align: center;
  }

  .bingo-card {
    display: grid;
    grid-template-columns: repeat(3, 100px);
    grid-template-rows: repeat(3, 100px);
    gap: 8px;
    justify-content: center;
    margin: 30px auto;
    position: relative;
  }

  .bingo-card div {
    width: 100px;
    height: 100px;
    line-height: 100px;
    font-size: 28px;
    background-color: white;
    border-radius: 10px;
    border: 2px solid #ccc;
    font-weight: bold;
    transition: background-color 0.3s, color 0.3s;
  }

  .marked {
    background-color: #ffb347 !important; /* Êòé„Çã„ÅÑ„Ç™„É¨„É≥„Ç∏ */
    color: white;
  }

  .bingo-line {
    position: absolute;
    background-color: pink;
    transform-origin: center;
    z-index: 5;
    border-radius: 5px;
  }

  .buttons {
    margin-top: 15px;
  }

  #numberInput {
    margin-top: 10px;
    padding: 8px 10px;
    font-size: 18px;
    width: 180px;
    text-align: center;
  }

  button {
    margin: 5px;
    padding: 8px 15px;
    font-size: 18px;
    cursor: pointer;
    border-radius: 5px;
    border: none;
  }

  #startStopBtn {
    background-color: #3cb371;
    color: white;
  }

  #shareBtn {
    background-color: #2196f3;
    color: white;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <main>
    <section class="bingo-card-section">
      <h1 class="page-title">APEX„Éì„É≥„Ç¥ üéØ</h1>
      <h2 id="cardTitle">„Éì„É≥„Ç¥„Ç´„Éº„Éâ</h2>

      <div id="bingoCard" class="bingo-card"></div>
      <div class="timestamp" id="cardTimestamp"></div>
    </section>
    
    <input type="text" id="numberInput" placeholder="Áï™Âè∑„ÇíÂÖ•ÂäõÔºà‰æã: 123Ôºâ">

    <div class="buttons">
      <button id="startStopBtn">ÊäΩÈÅ∏ÈñãÂßã</button>
      <button id="shareBtn">„Éì„É≥„Ç¥„Ç´„Éº„Éâ„ÇíÂÖ±Êúâ</button>
    </div>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
      authDomain: "catiffanygame.firebaseapp.com",
      databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
      projectId: "catiffanygame",
      storageBucket: "catiffanygame.firebasestorage.app",
      messagingSenderId: "166871605809",
      appId: "1:166871605809:web:1fe6e874fa06005ec46b10",
      measurementId: "G-ZNGEZZWMTP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const bingoCardRef = db.ref('bingoCard');

    const bingoCard = document.getElementById('bingoCard');
    const startStopBtn = document.getElementById('startStopBtn');
    const shareBtn = document.getElementById('shareBtn');
    const numberInput = document.getElementById('numberInput');
    const cardTitle = document.getElementById('cardTitle');
    const cardTimestamp = document.getElementById('cardTimestamp');

    let intervalId = null;
    let currentNumbers = [];

    function createCells() {
      bingoCard.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement('div');
        bingoCard.appendChild(cell);
      }
    }

    function shuffleNumbers() {
      const numbers = [...Array(9)].map((_, i) => i + 1);
      return numbers.sort(() => Math.random() - 0.5);
    }

    function startShuffle() {
      intervalId = setInterval(() => {
        currentNumbers = shuffleNumbers();
        bingoCard.querySelectorAll('div').forEach((cell, i) => {
          cell.textContent = currentNumbers[i];
          cell.classList.remove('marked');
        });
        removeLines();
      }, 50);
    }

    function stopShuffle() {
      clearInterval(intervalId);
      intervalId = null;

      const now = new Date();
      const formatted = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      cardTimestamp.textContent = formatted;

      bingoCardRef.set({
        numbers: currentNumbers,
        timestamp: formatted
      });
    }

    function removeLines() {
      document.querySelectorAll('.bingo-line').forEach(line => line.remove());
    }

    function checkBingo(marked) {
      const lines = [
        [0,1,2], [3,4,5], [6,7,8], // Ê®™
        [0,3,6], [1,4,7], [2,5,8], // Á∏¶
        [0,4,8], [2,4,6]           // Êñú„ÇÅ
      ];
      return lines.filter(line => line.every(i => marked.includes(i)));
    }

    function drawLine(type, index) {
      const line = document.createElement('div');
      line.classList.add('bingo-line');
      const size = 320; // „Ç´„Éº„ÉâÂÖ®‰Ωì„ÇíË¶Ü„ÅÜÈï∑„Åï
      const thickness = 12;

      line.style.width = type === 'diag' ? `${Math.sqrt(2)*size}px` : `${size}px`;
      line.style.height = `${thickness}px`;
      line.style.backgroundColor = 'pink';
      line.style.position = 'absolute';
      line.style.top = '50%';
      line.style.left = '50%';
      line.style.transformOrigin = 'center center';

      switch (type) {
        case 'row': line.style.transform = `translate(-50%, ${-100 + index * 108}px)`; break;
        case 'col': line.style.transform = `translate(-50%, -50%) rotate(90deg) translate(0, ${-100 + index * 108}px)`; break;
        case 'diag': line.style.transform = index === 0 ? 'translate(-50%, -50%) rotate(45deg)' : 'translate(-50%, -50%) rotate(-45deg)'; break;
      }

      bingoCard.appendChild(line);
    }

    numberInput.addEventListener('input', () => {
      const inputNumbers = numberInput.value.split('').map(n => parseInt(n)).filter(n => !isNaN(n));
      bingoCard.querySelectorAll('div').forEach((cell, i) => {
        if (inputNumbers.includes(currentNumbers[i])) {
          cell.classList.add('marked');
        } else {
          cell.classList.remove('marked');
        }
      });

      removeLines();
      const markedIndices = currentNumbers
        .map((num, idx) => inputNumbers.includes(num) ? idx : null)
        .filter(idx => idx !== null);
      const bingos = checkBingo(markedIndices);

      bingos.forEach(line => {
        if ([0,1,2].includes(line[0])) drawLine('row', Math.floor(line[0]/3));
        else if ([0,3,6].includes(line[0])) drawLine('col', line[0]%3);
        else drawLine('diag', line[0] === 0 ? 0 : 1);
      });
    });

    startStopBtn.addEventListener('click', () => {
      if (intervalId) {
        stopShuffle();
        startStopBtn.textContent = 'ÊäΩÈÅ∏ÈñãÂßã';
      } else {
        startShuffle();
        startStopBtn.textContent = 'ÂÅúÊ≠¢';
      }
    });

    shareBtn.addEventListener('click', async () => {
      const element = document.querySelector('.bingo-card-section');
      html2canvas(element).then(canvas => {
        canvas.toBlob(async (blob) => {
          const filesArray = [new File([blob], "bingo-card.png", {type: blob.type})];
          if (navigator.canShare && navigator.canShare({ files: filesArray })) {
            await navigator.share({
              files: filesArray,
              title: cardTitle.textContent,
              text: '„Éì„É≥„Ç¥„Ç´„Éº„Éâ„ÇíÂÖ±Êúâ„Åó„Åæ„Åô'
            });
          } else {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bingo-card.png';
            a.click();
            URL.revokeObjectURL(url);
          }
        });
      });
    });

    createCells();
  </script>
</body>
</html>