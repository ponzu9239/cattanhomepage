<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãã‚ƒãŸã‚“ã®APEXãƒ“ãƒ³ã‚´</title>
<link rel="stylesheet" href="common.css">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
  /* è¿½åŠ CSS */
  .highlight {
    background-color: #ffb347; /* æ˜ã‚‹ã„ã‚ªãƒ¬ãƒ³ã‚¸ */
    transition: background-color 0.3s;
  }

  .bingo-line {
    position: absolute;
    background-color: #ff69b4; /* ãƒ”ãƒ³ã‚¯è‰² */
    height: 8px;
    border-radius: 5px;
    transform-origin: center;
  }

  .bingo-card {
    position: relative;
  }

  #numberInput {
    display: block;
    margin: 20px auto;
    text-align: center;
    width: 60%;
    max-width: 300px;
    font-size: 18px;
    padding: 10px;
    border: 2px solid #1b656f;
    border-radius: 8px;
    background: #ffffffcc;
  }
</style>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <section class="bingo-card-section">
      <h1 class="page-title">APEXãƒ“ãƒ³ã‚´ ğŸ¯</h1>
      <h2 id="cardTitle">ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰</h2>

      <div id="bingoCard" class="bingo-card">
        <!-- 3Ã—3ã®æ•°å­—ã‚»ãƒ«ã‚’JSã§ç”Ÿæˆ -->
      </div>

      <div class="timestamp" id="cardTimestamp"></div>
    </section>
    
    <input type="text" id="numberInput" placeholder="ç•ªå·ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼š123ï¼‰">

    <div class="buttons">
      <button id="startStopBtn">æŠ½é¸é–‹å§‹</button>
      <button id="shareBtn">ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’å…±æœ‰</button>
    </div>

  </main>

  <div id="footer-placeholder"></div>

  <script src="common.js"></script>
  <script>
    setupHeader('header-user.html');

    // Firebase åˆæœŸåŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
      authDomain: "catiffanygame.firebaseapp.com",
      databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
      projectId: "catiffanygame",
      storageBucket: "catiffanygame.firebasestorage.app",
      messagingSenderId: "166871605809",
      appId: "1:166871605809:web:1fe6e874fa06005ec46b10",
      measurementId: "G-ZNGEZZWMTP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const bingoCardRef = db.ref('bingoCard');

    const bingoCard = document.getElementById('bingoCard');
    const startStopBtn = document.getElementById('startStopBtn');
    const shareBtn = document.getElementById('shareBtn');
    const numberInput = document.getElementById('numberInput');
    const cardTitle = document.getElementById('cardTitle');
    const cardTimestamp = document.getElementById('cardTimestamp');

    let intervalId = null;
    let currentNumbers = [];
    let lineElements = [];

    // 3x3ã®ã‚»ãƒ«ã‚’ç”Ÿæˆ
    function createCells() {
      bingoCard.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement('div');
        cell.textContent = '';
        bingoCard.appendChild(cell);
      }
    }

    // ãƒ©ãƒ³ãƒ€ãƒ æ•°å­—ã‚’å…¥ã‚Œã‚‹
    function shuffleNumbers() {
      const numbers = [...Array(9)].map((_, i) => i + 1);
      return numbers.sort(() => Math.random() - 0.5);
    }

    // é«˜é€Ÿã§å…¥ã‚Œæ›¿ãˆã‚‹
    function startShuffle() {
      intervalId = setInterval(() => {
        currentNumbers = shuffleNumbers();
        bingoCard.querySelectorAll('div').forEach((cell, i) => {
          cell.textContent = currentNumbers[i];
          cell.classList.remove('highlight');
        });
        clearLines();
      }, 50);
    }

    // åœæ­¢
    function stopShuffle() {
      clearInterval(intervalId);
      intervalId = null;

      const now = new Date();
      const formatted = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      cardTimestamp.textContent = formatted;

      bingoCardRef.set({
        numbers: currentNumbers,
        timestamp: formatted
      });
    }

    // ãƒ“ãƒ³ã‚´åˆ¤å®š
    function checkBingo(highlighted) {
      const lines = [
        [0,1,2],[3,4,5],[6,7,8], // æ¨ª
        [0,3,6],[1,4,7],[2,5,8], // ç¸¦
        [0,4,8],[2,4,6]          // æ–œã‚
      ];
      clearLines();

      lines.forEach(line => {
        if (line.every(i => highlighted.includes(i))) {
          drawBingoLine(line);
        }
      });
    }

    // ãƒ“ãƒ³ã‚´ãƒ©ã‚¤ãƒ³æç”»
    function drawBingoLine(indices) {
      const first = bingoCard.children[indices[0]];
      const last = bingoCard.children[indices[2]];
      const rect1 = first.getBoundingClientRect();
      const rect2 = last.getBoundingClientRect();
      const parentRect = bingoCard.getBoundingClientRect();

      const line = document.createElement('div');
      line.classList.add('bingo-line');
      const x1 = rect1.left + rect1.width / 2 - parentRect.left;
      const y1 = rect1.top + rect1.height / 2 - parentRect.top;
      const x2 = rect2.left + rect2.width / 2 - parentRect.left;
      const y2 = rect2.top + rect2.height / 2 - parentRect.top;
      const length = Math.hypot(x2 - x1, y2 - y1) * 1.1; // å°‘ã—é•·ã
      const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;

      line.style.width = `${length}px`;
      line.style.left = `${(x1 + x2) / 2 - length / 2}px`;
      line.style.top = `${(y1 + y2) / 2 - 4}px`;
      line.style.transform = `rotate(${angle}deg)`;
      bingoCard.appendChild(line);
      lineElements.push(line);
    }

    function clearLines() {
      lineElements.forEach(line => line.remove());
      lineElements = [];
    }

    // ç•ªå·å…¥åŠ›ã§å…‰ã‚‰ã›ã‚‹
    numberInput.addEventListener('input', () => {
      const value = numberInput.value.replace(/[^0-9]/g, '');
      const highlightCells = [];
      bingoCard.querySelectorAll('div').forEach((cell, i) => {
        const num = parseInt(cell.textContent);
        if (value.includes(num)) {
          cell.classList.add('highlight');
          highlightCells.push(i);
        } else {
          cell.classList.remove('highlight');
        }
      });
      checkBingo(highlightCells);
    });

    // é–‹å§‹/åœæ­¢ãƒœã‚¿ãƒ³
    startStopBtn.addEventListener('click', () => {
      if (intervalId) {
        stopShuffle();
        startStopBtn.textContent = 'æŠ½é¸é–‹å§‹';
      } else {
        startShuffle();
        startStopBtn.textContent = 'åœæ­¢';
      }
    });

    // å…±æœ‰ãƒœã‚¿ãƒ³
    shareBtn.addEventListener('click', async () => {
      const element = document.querySelector('.bingo-card-section');
      html2canvas(element).then(canvas => {
        canvas.toBlob(async (blob) => {
          const filesArray = [new File([blob], "bingo-card.png", {type: blob.type})];
          if (navigator.canShare && navigator.canShare({ files: filesArray })) {
            try {
              await navigator.share({
                files: filesArray,
                title: 'ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰',
                text: 'ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’å…±æœ‰ã—ã¾ã™'
              });
            } catch (err) {
              alert('å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
            }
          }
        });
      });
    });

    // åˆæœŸåŒ–
    createCells();
  </script>
</body>
</html>