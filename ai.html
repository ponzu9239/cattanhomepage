<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãã‚ƒãŸã‚“ã®APEXãƒ“ãƒ³ã‚´</title>
<link rel="stylesheet" href="common.css">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <section class="bingo-card-section">
      <h1 class="page-title">APEXãƒ“ãƒ³ã‚´ ğŸ¯</h1>
      <h2 id="cardTitle">ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰</h2>

      <div id="bingoCard" class="bingo-card"></div>

      <div class="timestamp" id="cardTimestamp"></div>
      <canvas id="bingoLineCanvas" style="position:absolute; top:0; left:0;"></canvas>
    </section>
    
    <input type="number" id="numberInput" placeholder="ç•ªå·ã‚’å…¥åŠ›">

    <div class="buttons">
      <button id="startStopBtn">æŠ½é¸é–‹å§‹</button>
      <button id="shareBtn">ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’å…±æœ‰</button>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script src="common.js"></script>
  <script>
    // ãƒ˜ãƒƒãƒ€ãƒ¼èª­ã¿è¾¼ã¿
    if (typeof setupHeader === 'function') setupHeader('header-user.html');

    const bingoCard = document.getElementById('bingoCard');
    const startStopBtn = document.getElementById('startStopBtn');
    const shareBtn = document.getElementById('shareBtn');
    const numberInput = document.getElementById('numberInput');
    const cardTitle = document.getElementById('cardTitle');
    const cardTimestamp = document.getElementById('cardTimestamp');
    const canvas = document.getElementById('bingoLineCanvas');
    const ctx = canvas.getContext('2d');

    let intervalId = null;
    let currentNumbers = [];
    let markedNumbers = [];

    // ã‚»ãƒ«ä½œæˆ
    function createCells() {
      bingoCard.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement('div');
        cell.classList.add('bingo-cell');
        cell.textContent = '';
        cell.style.transition = 'background 0.3s';
        bingoCard.appendChild(cell);
      }
    }

    // ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    function shuffleNumbers() {
      return [...Array(9)].map((_, i) => i + 1).sort(() => Math.random() - 0.5);
    }

    // æŠ½é¸é–‹å§‹
    function startShuffle() {
      intervalId = setInterval(() => {
        currentNumbers = shuffleNumbers();
        bingoCard.querySelectorAll('div').forEach((cell, i) => {
          cell.textContent = currentNumbers[i];
          cell.classList.remove('highlight'); // ãƒªã‚»ãƒƒãƒˆ
        });
        markedNumbers = [];
        clearCanvas();
      }, 50);
    }

    // æŠ½é¸åœæ­¢
    function stopShuffle() {
      clearInterval(intervalId);
      intervalId = null;

      currentNumbers.forEach((num, i) => {
        bingoCard.children[i].textContent = num;
      });

      const now = new Date();
      const formatted = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      cardTimestamp.textContent = formatted;
    }

    // ãƒã‚¹ã‚’å…‰ã‚‰ã›ã‚‹
    function markNumber(num) {
      markedNumbers.push(num);
      bingoCard.querySelectorAll('div').forEach(cell => {
        if (Number(cell.textContent) === num) {
          cell.classList.add('highlight');
        }
      });
      checkBingo();
    }

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // ãƒ“ãƒ³ã‚´åˆ¤å®š
    function checkBingo() {
      const cells = Array.from(bingoCard.children).map(c => c.classList.contains('highlight'));
      const lines = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      lines.forEach(line => {
        if (line.every(i => cells[i])) drawBingoLine(line);
      });
    }

    function drawBingoLine(line) {
      clearCanvas();
      const rect = bingoCard.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      ctx.strokeStyle = 'red';
      ctx.lineWidth = 8;
      ctx.lineCap = 'round';
      const cellWidth = rect.width / 3;
      const cellHeight = rect.height / 3;

      const startCell = line[0];
      const endCell = line[2];

      const startX = (startCell % 3 + 0.5) * cellWidth;
      const startY = (Math.floor(startCell / 3) + 0.5) * cellHeight;
      const endX = (endCell % 3 + 0.5) * cellWidth;
      const endY = (Math.floor(endCell / 3) + 0.5) * cellHeight;

      ctx.beginPath();
      ctx.moveTo(startX, startY);
      ctx.lineTo(endX, endY);
      ctx.stroke();
    }

    // ç•ªå·å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¤‡æ•°åŒæ™‚ã«å…‰ã‚‰ã›ã‚‹ï¼‰
    numberInput.addEventListener('change', () => {
        const input = numberInput.value.trim();
        if (!input) return;

        // å…¨ã‚»ãƒ«ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
        Array.from(bingoCard.children).forEach(cell => {
            cell.classList.remove('highlight');
        });

        for (const char of input) {
            const num = Number(char);
            if (!isNaN(num) && currentNumbers.includes(num)) {
                const cell = Array.from(bingoCard.children).find(c => Number(c.textContent) === num);
                if (cell) cell.classList.add('highlight');
            }
        }

        numberInput.value = '';
    });

    // æŠ½é¸ãƒœã‚¿ãƒ³
    startStopBtn.addEventListener('click', () => {
      if (intervalId) {
        stopShuffle();
        startStopBtn.textContent = 'æŠ½é¸é–‹å§‹';
      } else {
        startShuffle();
        startStopBtn.textContent = 'åœæ­¢';
      }
    });

    // å…±æœ‰ãƒœã‚¿ãƒ³
    shareBtn.addEventListener('click', async () => {
      const element = document.querySelector('.bingo-card-section');
      const canvasShare = await html2canvas(element);
      canvasShare.toBlob(async (blob) => {
        const file = new File([blob], "bingo-card.png", {type: blob.type});
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          try { await navigator.share({ files: [file], title: cardTitle.textContent, text: 'ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’å…±æœ‰ã—ã¾ã™' }); }
          catch (err) { alert('å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err); }
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'bingo-card.png';
          a.click();
          URL.revokeObjectURL(url);
        }
      });
    });

    // åˆæœŸåŒ–
    createCells();
  </script>
</body>
</html>