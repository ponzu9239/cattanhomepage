<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>きゃたんのAPEXビンゴ</title>
<link rel="stylesheet" href="common.css">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <section class="bingo-card-section">
      <h1 class="page-title">APEXビンゴ 🎯</h1>
      <h2 id="cardTitle">ビンゴカード</h2>

      <div id="bingoCard" class="bingo-card">
        <!-- 3x3のセルをJSで生成 -->
        <canvas id="bingoLineCanvas"></canvas>
      </div>

      <div class="timestamp" id="cardTimestamp"></div>
    </section>
    
    <input type="number" id="numberInput" placeholder="番号を入力">

    <div class="buttons">
      <button id="startStopBtn">抽選開始</button>
      <button id="shareBtn">ビンゴカードを共有</button>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script src="common.js"></script>
  <script>
      setupHeader('header-user.html');
  
  const firebaseConfig = {
  apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
  authDomain: "catiffanygame.firebaseapp.com",
  databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
  projectId: "catiffanygame",
  storageBucket: "catiffanygame.firebasestorage.app",
  messagingSenderId: "166871605809",
  appId: "1:166871605809:web:1fe6e874fa06005ec46b10",
  measurementId: "G-ZNGEZZWMTP"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const bingoCardRef = db.ref('bingoCard');       // カードの数字
const markedNumbersRef = db.ref('markedNumbers'); // 入力された番号
  
    const bingoCard = document.getElementById('bingoCard');
    const startStopBtn = document.getElementById('startStopBtn');
    const shareBtn = document.getElementById('shareBtn');
    const numberInput = document.getElementById('numberInput');
    const cardTimestamp = document.getElementById('cardTimestamp');
    const canvas = document.getElementById('bingoLineCanvas');
    const ctx = canvas.getContext('2d');

    let intervalId = null;
    let currentNumbers = [];
    let markedNumbers = [];

function createCells() {
  bingoCard.innerHTML = '';
  for (let i = 0; i < 9; i++) {
    const cell = document.createElement('div');
    cell.classList.add('bingo-cell');
    cell.textContent = '';
    bingoCard.appendChild(cell);
  }
  resizeCanvas();
}

    function shuffleNumbers() {
      return [...Array(9)].map((_, i) => i + 1).sort(() => Math.random() - 0.5);
    }

    function startShuffle() {
      intervalId = setInterval(() => {
        currentNumbers = shuffleNumbers();
        bingoCard.querySelectorAll('.bingo-cell').forEach((cell, i) => {
          cell.textContent = currentNumbers[i];
          cell.classList.remove('highlight');
        });
        markedNumbers = [];
        clearCanvas();
      }, 50);
    }

function stopShuffle() {
  clearInterval(intervalId);
  intervalId = null;

  // タイトル更新
  const name = playerNameInput.value.trim();
  cardTitle.textContent = name ? `${name}のカード` : 'ビンゴカード';

  // タイムスタンプ
  const now = new Date();
  const formatted = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  cardTimestamp.textContent = formatted;

  // Firebase にカード情報送信
  bingoCardRef.set({
    numbers: currentNumbers,
    playerName: name,
    timestamp: formatted
  });
}

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

function resizeCanvas() {
  const rect = bingoCard.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  canvas.style.position = 'absolute';
  canvas.style.left = rect.left + 'px';
  canvas.style.top = rect.top + 'px';
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(dpr, dpr);
}

    function checkBingo() {
      const cells = Array.from(bingoCard.querySelectorAll('.bingo-cell')).map(c => c.classList.contains('highlight'));
      const lines = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      clearCanvas();
      lines.forEach(line => {
        if (line.every(i => cells[i])) drawBingoLine(line);
      });
    }

function drawBingoLine(line) {
  const cells = bingoCard.querySelectorAll('.bingo-cell');

  // 始点と終点のセル
  const startCell = cells[line[0]].getBoundingClientRect();
  const endCell = cells[line[2]].getBoundingClientRect();
  const cardRect = bingoCard.getBoundingClientRect();

  // canvas 内座標に変換
  const dpr = window.devicePixelRatio || 1;
  const offsetX = cardRect.left;
  const offsetY = cardRect.top;

  const startX = (startCell.left + startCell.right)/2 - offsetX;
  const startY = (startCell.top + startCell.bottom)/2 - offsetY;
  const endX = (endCell.left + endCell.right)/2 - offsetX;
  const endY = (endCell.top + endCell.bottom)/2 - offsetY;

  ctx.strokeStyle = 'red';
  ctx.lineWidth = 8;
  ctx.lineCap = 'round';
  ctx.beginPath();
  ctx.moveTo(startX, startY);
  ctx.lineTo(endX, endY);
  ctx.stroke();
}

numberInput.addEventListener('input', () => {
  const input = numberInput.value.trim();
  if (!input) return;

  // 全セルのハイライトをリセット
  Array.from(bingoCard.children).forEach(cell => cell.classList.remove('highlight'));
  const markedNumbers = [];

  // 入力文字を処理
  for (const char of input) {
    const num = Number(char);
    if (!isNaN(num) && currentNumbers.includes(num)) {
      const cell = Array.from(bingoCard.children).find(c => Number(c.textContent) === num);
      if (cell && !cell.classList.contains('highlight')) {
        cell.classList.add('highlight');
        markedNumbers.push(num);
      }
    }
  }

  // Firebase にマークされた番号を送信
  markedNumbersRef.set(markedNumbers);

  checkBingo(); // 線の描画など
});

    startStopBtn.addEventListener('click', () => {
      if (intervalId) {
        stopShuffle();
        startStopBtn.textContent = '抽選開始';
      } else {
        startShuffle();
        startStopBtn.textContent = '停止';
      }
    });

    shareBtn.addEventListener('click', async () => {
      const element = document.querySelector('.bingo-card-section');
      const canvasShare = await html2canvas(element);
      canvasShare.toBlob(async (blob) => {
        const file = new File([blob], "bingo-card.png", {type: blob.type});
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          try { await navigator.share({ files: [file], title: 'APEXビンゴ', text: 'ビンゴカードを共有します' }); }
          catch (err) { alert('共有に失敗しました: ' + err); }
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'bingo-card.png';
          a.click();
          URL.revokeObjectURL(url);
        }
      });
    });

    createCells();
    window.addEventListener('resize', () => {
      resizeCanvas();
      checkBingo();
    });
  </script>
  <style>
.bingo-card {
  position: relative;
  width: 300px;
  height: 300px;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(3, 1fr);
  gap: 5px;
}

.bingo-cell {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  background: #fff;
  border: 2px solid #000;
}

#bingoLineCanvas {
  position: absolute;
  top: 0;
  left: 0;
  pointer-events: none; /* マスのクリックを邪魔しない */
}
</style>
</body>
</html>