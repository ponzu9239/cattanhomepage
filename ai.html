<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãã‚ƒãŸã‚“ã®APEXãƒ“ãƒ³ã‚´ ğŸ¯</title>
<link rel="stylesheet" href="common.css">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
  /* å…‰ã‚‹æ¼”å‡ºç”¨ */
  .highlight {
    background-color: yellow;
    transition: background-color 0.3s;
  }
  #bingoLineCanvas {
    position: absolute;
    pointer-events: none;
  }
  
  #bingo-card {
  display: grid;
  grid-template-columns: repeat(5, 60px);
  gap: 8px;
  justify-content: center;
  margin: 20px auto;
  position: relative;
}

.cell {
  width: 60px;
  height: 60px;
  background: white;
  border-radius: 8px;
  line-height: 60px;
  font-weight: bold;
  font-size: 20px;
  color: #333;
  transition: background 0.3s ease, color 0.3s ease;
}

.cell.free {
  background: #ffcc80;
}

.cell.active {
  background: #ffb347; /* ã‚ªãƒ¬ãƒ³ã‚¸å¯„ã‚Šã®è‰² */
  color: white;
}

.line {
  position: absolute;
  height: 10px; /* å¤ªãã™ã‚‹ */
  background: #ff66b2; /* ãƒ”ãƒ³ã‚¯è‰² */
  transform-origin: left center;
  border-radius: 5px;
  filter: drop-shadow(0 0 6px #ff99cc);
}

/* ç·šãŒã‚«ãƒ¼ãƒ‰ã‚’å°‘ã—ã¯ã¿å‡ºã—ã¦è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ */
#bingo-card .line {
  left: -10px;
  right: -10px;
}
  
input, button {
  padding: 8px 12px;
  font-size: 16px;
  margin: 10px;
  border-radius: 6px;
  border: none;
}

button {
  background: #1b656f;
  color: white;
  cursor: pointer;
</style>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <section class="bingo-card-section" style="position:relative;">
      <h1 class="page-title">APEXãƒ“ãƒ³ã‚´ ğŸ¯</h1>
      <h2 id="cardTitle">ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰</h2>

      <div id="bingoCard" class="bingo-card"></div>
      <canvas id="bingoLineCanvas"></canvas>

      <div class="timestamp" id="cardTimestamp"></div>
    </section>
    
    <input type="text" id="playerName" placeholder="åå‰ã‚’å…¥åŠ›">
    <input type="text" id="highlightNumbers" placeholder="ç•ªå·ã‚’é€£ç¶šã§å…¥åŠ› (ä¾‹:123)">

    <div class="buttons">
      <button id="startStopBtn">æŠ½é¸é–‹å§‹</button>
      <button id="shareBtn">ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’å…±æœ‰</button>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script src="common.js"></script>
  <script>
    setupHeader('header-user.html');

    // Firebase åˆæœŸåŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
      authDomain: "catiffanygame.firebaseapp.com",
      databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
      projectId: "catiffanygame",
      storageBucket: "catiffanygame.firebasestorage.app",
      messagingSenderId: "166871605809",
      appId: "1:166871605809:web:1fe6e874fa06005ec46b10",
      measurementId: "G-ZNGEZZWMTP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const bingoCardRef = db.ref('bingoCard');

    const bingoCard = document.getElementById('bingoCard');
    const startStopBtn = document.getElementById('startStopBtn');
    const shareBtn = document.getElementById('shareBtn');
    const playerNameInput = document.getElementById('playerName');
    const highlightInput = document.getElementById('highlightNumbers');
    const cardTitle = document.getElementById('cardTitle');
    const cardTimestamp = document.getElementById('cardTimestamp');
    const bingoLineCanvas = document.getElementById('bingoLineCanvas');

    let intervalId = null;
    let currentNumbers = [];

    function createCells() {
        bingoCard.innerHTML = '';
        for (let i=0; i<9; i++) {
            const cell = document.createElement('div');
            cell.classList.add('bingo-cell');
            bingoCard.appendChild(cell);
        }
        bingoLineCanvas.width = bingoCard.offsetWidth;
        bingoLineCanvas.height = bingoCard.offsetHeight;
        bingoLineCanvas.style.top = bingoCard.offsetTop + 'px';
        bingoLineCanvas.style.left = bingoCard.offsetLeft + 'px';
      }

    function shuffleNumbers() {
        return [...Array(9)].map((_,i)=>i+1).sort(()=>Math.random()-0.5);
    }

    function startShuffle() {
        intervalId = setInterval(()=>{
            currentNumbers = shuffleNumbers();
            bingoCard.querySelectorAll('.bingo-cell').forEach((cell,i)=>{
                cell.textContent = currentNumbers[i];
            });
            highlightNumbers(); // é«˜é€Ÿå›è»¢ä¸­ã‚‚å…‰ã‚‰ã›ã‚‹
        },50);
    }

    function stopShuffle() {
        clearInterval(intervalId);
        intervalId = null;

        const name = playerNameInput.value.trim();
        cardTitle.textContent = name ? `${name}ã®ã‚«ãƒ¼ãƒ‰` : 'ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰';

        const now = new Date();
        const formatted = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        cardTimestamp.textContent = formatted;

        bingoCardRef.set({
            numbers: currentNumbers,
            playerName: name,
            timestamp: formatted
        });

        highlightNumbers();
    }

    playerNameInput.addEventListener('input', ()=>{
        const name = playerNameInput.value.trim();
        cardTitle.textContent = name ? `${name}ã®ã‚«ãƒ¼ãƒ‰` : 'ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰';
    });

    highlightInput.addEventListener('input', highlightNumbers);

    function highlightNumbers() {
        const input = highlightInput.value.replace(/\D/g,'');
        const highlightValues = input.split('');
        const cells = bingoCard.querySelectorAll('.bingo-cell');
        cells.forEach(cell=>{
            cell.classList.toggle('highlight', highlightValues.includes(cell.textContent));
        });
        drawBingoLine(highlightValues);
    }

    function drawBingoLine(highlightValues){
        const ctx = bingoLineCanvas.getContext('2d');
        ctx.clearRect(0,0,bingoLineCanvas.width,bingoLineCanvas.height);
        const cells = Array.from(bingoCard.querySelectorAll('.bingo-cell'));
        const indices = cells.map((cell,i)=>highlightValues.includes(cell.textContent)?i:-1).filter(i=>i>=0);
        const patterns = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        for(const pattern of patterns){
            if(pattern.every(idx=>indices.includes(idx))){
                const first = cells[pattern[0]].getBoundingClientRect();
                const last = cells[pattern[2]].getBoundingClientRect();
                const rect = bingoCard.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo(first.left-rect.left+first.width/2, first.top-rect.top+first.height/2);
                ctx.lineTo(last.left-rect.left+last.width/2, last.top-rect.top+last.height/2);
                ctx.strokeStyle='red';
                ctx.lineWidth=4;
                ctx.stroke();
            }
        }
    }

    startStopBtn.addEventListener('click', ()=>{
        if(intervalId) stopShuffle(), startStopBtn.textContent='æŠ½é¸é–‹å§‹';
        else startShuffle(), startStopBtn.textContent='åœæ­¢';
    });

    shareBtn.addEventListener('click', async ()=>{
        const element = document.querySelector('.bingo-card-section');
        html2canvas(element).then(canvas=>{
            canvas.toBlob(async blob=>{
                const filesArray=[new File([blob],"bingo-card.png",{type:blob.type})];
                if(navigator.canShare && navigator.canShare({files:filesArray})){
                    try{await navigator.share({files:filesArray,title:cardTitle.textContent,text:'ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ã‚’å…±æœ‰ã—ã¾ã™'});}
                    catch(err){alert('å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: '+err);}
                }else{
                    const url = URL.createObjectURL(blob);
                    const a=document.createElement('a');
                    a.href=url;
                    a.download='bingo-card.png';
                    a.click();
                    URL.revokeObjectURL(url);
                }
            });
        });
    });

    createCells();
  </script>
</body>
</html>