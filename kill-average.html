<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>プレイヤースコア計算（履歴考慮版）</title>
  <style>
    body { font-family: "Hiragino Maru Gothic ProN", sans-serif; background-color: #f7fcfc; padding: 20px; }
    h1 { text-align: center; color: #47b6a2; }
    table { width: 90%; margin: 20px auto; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
    th { background: #97eadb; color: white; }
    tr:hover { background: #f0faf9; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <h1>プレイヤースコア計算（2試合前まで＋直近1試合）</h1>

  <table>
    <thead><tr><th>プレイヤー名</th><th>スコア</th></tr></thead>
    <tbody id="resultTable"></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbHLIr4GWkZ3Mfbg3M8wOY68X1ITrE-yw",
      authDomain: "match-result-ea475.firebaseapp.com",
      databaseURL: "https://match-result-ea475-default-rtdb.firebaseio.com",
      projectId: "match-result-ea475",
      storageBucket: "match-result-ea475.firebasestorage.app",
      messagingSenderId: "759877853492",
      appId: "1:759877853492:web:a10935960bf8230af90561"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function calculateDiffScoreHistory(matches) {
      const history = {};

      matches.sort((a, b) => a.matchNumber - b.matchNumber);

      matches.forEach(match => {
        if (!match.teamA || !match.teamB) return;

        const teamAScore = match.teamAKills;
        const teamBScore = match.teamBKills;
        const teamASize = match.teamA.length;
        const teamBSize = match.teamB.length;

        const teamAWins = teamAScore > teamBScore;
        const teamBWins = teamBScore > teamAScore;

        const multiplierA = teamAWins ? (teamBSize / teamASize) : (teamASize / teamBSize);
        const diffA = (teamAScore - teamBScore) * multiplierA;

        const multiplierB = teamBWins ? (teamASize / teamBSize) : (teamBSize / teamASize);
        const diffB = (teamBScore - teamAScore) * multiplierB;

        match.teamA.forEach(p => {
          if (!history[p]) history[p] = [];
          history[p].push(diffA);
        });
        match.teamB.forEach(p => {
          if (!history[p]) history[p] = [];
          history[p].push(diffB);
        });
      });

      const results = [];

      Object.keys(history).forEach(name => {
        const scores = history[name];
        if (scores.length === 0) {
          results.push({ name, score: "0.00" });
          return;
        }

        const last = scores[scores.length - 1] ?? 0;
        const prevScores = scores.slice(0, -1); // 直近1試合を除く全試合
        const prevAvg =
          prevScores.length > 0
            ? prevScores.reduce((a, b) => a + b, 0) / prevScores.length
            : 0;

        const finalScore = prevAvg + last;
        results.push({ name, score: finalScore.toFixed(2) });
      });

      return results;
    }

    function renderResults(scores) {
      const tbody = document.getElementById("resultTable");
      tbody.innerHTML = "";
      scores.sort((a, b) => b.score - a.score).forEach(player => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${player.name}</td><td>${player.score}</td>`;
        tbody.appendChild(tr);
      });
    }

    db.ref("apex_results").on("value", snapshot => {
      if (!snapshot.exists()) return;
      const matches = Object.values(snapshot.val());
      const scores = calculateDiffScoreHistory(matches);
      renderResults(scores);
    });
  </script>
</body>
</html>