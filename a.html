<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>„Åç„ÇÉ„Åü„Çì „É´„Éº„É¨„ÉÉ„Éà</title>
  <style>
    body {
      font-family: "Hiragino Maru Gothic ProN", sans-serif;
      background-color: #fff9f9;
      text-align: center;
      padding: 2rem;
    }
    h1 { color: #97EADB; }
    canvas { margin-top: 20px; }
    #winnerDisplay {
      font-size: 2rem;
      font-weight: bold;
      margin-top: 20px;
      color: #FFD700;
      text-shadow: 2px 2px 4px #000;
    }
    @keyframes winnerPop {
      0% { transform: scale(1); opacity: 0.2; }
      50% { transform: scale(1.3); opacity: 1; }
      100% { transform: scale(1); }
    }
    .winner-animated {
      animation: winnerPop 0.6s ease;
      display: inline-block;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
  <h1>üé∞ „Åç„ÇÉ„Åü„Çì „É´„Éº„É¨„ÉÉ„Éà</h1>
  <canvas id="rouletteCanvas" width="400" height="400"></canvas>
  <div id="winnerDisplay"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
      authDomain: "catiffanygame.firebaseapp.com",
      databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
      projectId: "catiffanygame",
      storageBucket: "catiffanygame.appspot.com",
      messagingSenderId: "166871605809",
      appId: "1:166871605809:web:1fe6e874fa06005ec46b10"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const canvas = document.getElementById("rouletteCanvas");
    const ctx = canvas.getContext("2d");
    let participants = [];
    let colors = [];
    let angle = 0;
    let velocity = 0;
    let spinning = false;

    function randomPastelColor() {
      const r = Math.floor(Math.random() * 127 + 127);
      const g = Math.floor(Math.random() * 127 + 127);
      const b = Math.floor(Math.random() * 127 + 127);
      return `rgb(${r},${g},${b})`;
    }

    function drawRoulette() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 150;

      if (participants.length === 0) return;
      const arc = (2 * Math.PI) / participants.length;

      for (let i = 0; i < participants.length; i++) {
        const start = angle + i * arc;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, start, start + arc);
        ctx.closePath();
        ctx.fillStyle = colors[i];
        ctx.fill();

        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(start + arc / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#333";
        ctx.font = "16px Hiragino Maru Gothic ProN";
        ctx.fillText(participants[i].name, radius - 10, 5);
        ctx.restore();
      }

      // „Éù„Ç§„É≥„Çø
      ctx.beginPath();
      ctx.moveTo(centerX, centerY - radius - 10);
      ctx.lineTo(centerX - 10, centerY - radius - 25);
      ctx.lineTo(centerX + 10, centerY - radius - 25);
      ctx.closePath();
      ctx.fillStyle = "#FF69B4";
      ctx.fill();
    }

    function animate() {
      if (spinning) {
        angle += velocity;
        angle %= 2 * Math.PI;
      }
      drawRoulette();
      requestAnimationFrame(animate);
    }

    // ÂèÇÂä†ËÄÖ„É™„Çπ„Éà„ÅÆÂêåÊúü
    db.ref("/roulette/participants").on("value", (snapshot) => {
      const data = snapshot.val() || [];
      participants = data;
      colors = participants.map(() => randomPastelColor());
      drawRoulette();
    });

    // üî• „É´„Éº„É¨„ÉÉ„ÉàÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
    db.ref("/roulette/status").on("value", (snapshot) => {
      const status = snapshot.val();
      if (status === "spinning") {
        spinning = true;
        velocity = 0.5; // üî• È´òÈÄüÂõûËª¢
        document.getElementById("winnerDisplay").textContent = "";
      } else {
        spinning = false;
        velocity = 0;
      }
    });

    // üî• ÂΩìÈÅ∏ËÄÖ„ÅÆÁõ£Ë¶ñ
    db.ref("/roulette/currentName").on("value", (snapshot) => {
      // spinning‰∏≠„ÅØË°®Á§∫„Åó„Å™„ÅÑ
    });

    db.ref("/roulette/winner").on("child_added", (snapshot) => {
      const winner = snapshot.val();
      if (winner) {
        const el = document.getElementById("winnerDisplay");
        el.textContent = `üéâ ÂΩìÈÅ∏ËÄÖ: ${winner}`;
        el.classList.remove("winner-animated");
        void el.offsetWidth;
        el.classList.add("winner-animated");
      }
    });

    animate();
  </script>
</body>
</html>