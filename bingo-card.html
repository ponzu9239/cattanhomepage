<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ビンゴカードジェネレーター</title>
    <link rel="stylesheet" href="common.css">
</head>
<body>

<!-- ヘッダー読み込み用 -->
<div id="header-placeholder"></div>

<main>
    <div style="text-align:center; margin-top:20px;">
        <input type="text" id="playerName" placeholder="名前を入力">
    </div>
    
    <div id="cardTitle"></div>

    <div id="bingoCardContainer">
        <div class="bingo-card" id="bingoCard">
            <div class="bingo-cell">-</div>
            <div class="bingo-cell">-</div>
            <div class="bingo-cell">-</div>
            <div class="bingo-cell">-</div>
            <div class="bingo-cell">-</div>
            <div class="bingo-cell">-</div>
            <div class="bingo-cell">-</div>
            <div class="bingo-cell">-</div>
            <div class="bingo-cell">-</div>
        </div>
        <div id="cardTimestamp"></div>
    </div>

    <div style="text-align:center; margin-top:10px;">
        <button id="generateBtn">抽選開始/停止</button>
        <button id="shareBtn">カードを共有</button>
    </div>
</main>

<!-- フッター読み込み用 -->
<div id="footer-placeholder"></div>

<script>
// ヘッダー/フッター読み込み
async function loadComponent(id, url){
    const resp = await fetch(url);
    if(resp.ok){
        document.getElementById(id).innerHTML = await resp.text();
    }
}
loadComponent('header-placeholder','header-user.html');
loadComponent('footer-placeholder','footer.html');

// 3×3ビンゴカード
const cardCells = Array.from(document.querySelectorAll('.bingo-cell'));
const generateBtn = document.getElementById('generateBtn');
const shareBtn = document.getElementById('shareBtn');
const playerNameInput = document.getElementById('playerName');
const cardTitle = document.getElementById('cardTitle');
const cardTimestamp = document.getElementById('cardTimestamp');

let interval = null;

function getRandomCard(){
    const nums = [1,2,3,4,5,6,7,8,9];
    const card = [];
    for(let i=0;i<9;i++){
        const idx = Math.floor(Math.random()*nums.length);
        card.push(nums.splice(idx,1)[0]);
    }
    return card;
}

function updateCardDisplay(card){
    card.forEach((num,i)=>{
        cardCells[i].textContent = num;
    });
}

function updateTitleAndTimestamp(){
    const name = playerNameInput.value.trim();
    cardTitle.textContent = name ? `${name}のビンゴカード` : '';
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    cardTimestamp.textContent = `${y}/${m}/${d} ${hh}:${mm}`;
}

// 抽選開始/停止
generateBtn.addEventListener('click',()=>{
    if(interval){
        clearInterval(interval);
        interval = null;
        // 最終確定
        updateCardDisplay(getRandomCard());
        updateTitleAndTimestamp();
    }else{
        interval = setInterval(()=>{
            updateCardDisplay(getRandomCard());
        },50); // 50msごとに数字が入れ替わる
    }
});

// カードを共有
shareBtn.addEventListener('click',()=>{
    // canvasに描画して画像化
    const canvas = document.createElement('canvas');
    canvas.width = 300;
    canvas.height = 400;
    const ctx = canvas.getContext('2d');

    // 背景
    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // タイトル
    ctx.fillStyle = '#007070';
    ctx.font = 'bold 18px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(cardTitle.textContent, canvas.width/2, 30);

    // ビンゴ数字
    ctx.fillStyle = '#1b656f';
    ctx.font = 'bold 24px sans-serif';
    const cellSize = 80;
    const gap = 5;
    cardCells.forEach((cell,i)=>{
        const x = (i%3)*(cellSize+gap) + 20;
        const y = Math.floor(i/3)*(cellSize+gap) + 60;
        ctx.fillStyle = '#d4f0f4';
        ctx.fillRect(x,y,cellSize,cellSize);
        ctx.strokeStyle = '#00a0b0';
        ctx.lineWidth = 2;
        ctx.strokeRect(x,y,cellSize,cellSize);
        ctx.fillStyle = '#1b656f';
        ctx.fillText(cell.textContent,x+cellSize/2,y+cellSize/2 +8);
    });

    // タイムスタンプ
    ctx.fillStyle = '#888';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(cardTimestamp.textContent, canvas.width-10, canvas.height-10);

    // 画像を共有
    canvas.toBlob(blob=>{
        const file = new File([blob],'bingo.png',{type:'image/png'});
        if(navigator.canShare && navigator.canShare({files:[file]})){
            navigator.share({files:[file], title:'ビンゴカード'});
        }else{
            // fallback: 新しいタブで表示
            const url = URL.createObjectURL(blob);
            window.open(url,'_blank');
        }
    });
});
</script>

</body>
</html>