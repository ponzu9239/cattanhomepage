<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ビンゴカードジェネレーター</title>
<link rel="stylesheet" href="common.css">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
/* bingoカード固有スタイル */
#bingoCardContainer {
    text-align: center;
    margin-top: 20px;
    display: inline-block;
    padding: 12px;
    border: 3px solid var(--color-primary);
    border-radius: 12px;
    background: #fff;
}
#cardTitle {
    font-weight: bold;
    margin-bottom: 8px;
    color: var(--color-accent);
}
.bingo-card {
    display: grid;
    grid-template-columns: repeat(3, 80px);
    grid-template-rows: repeat(3, 80px);
    gap: 5px;
    justify-content: center;
    margin-bottom: 8px;
}
.bingo-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 24px;
    background: #d4f0f4;
    border: 2px solid var(--color-primary);
    border-radius: 8px;
}
#cardTimestamp {
    font-size: 10px;
    color: #888;
    text-align: right;
}
button {
    margin: 6px;
    padding: 6px 12px;
    font-weight: bold;
    border-radius: 8px;
    border: none;
    cursor: pointer;
}
#generateBtn {
    background: var(--color-primary);
    color: white;
}
#shareBtn {
    background: var(--color-accent);
    color: white;
}
input[type="text"] {
    padding: 4px 6px;
    border: 2px solid var(--color-primary);
    border-radius: 8px;
    width: 150px;
    margin-bottom: 6px;
}
</style>
</head>
<body>
<div id="header-placeholder"></div>

<div style="text-align:center; margin-top:160px;">
    <input type="text" id="playerName" placeholder="名前を入力">
    <br>
    <button id="generateBtn">抽選開始 / 停止</button>
    <button id="shareBtn">カードを共有</button>
</div>

<div id="bingoCardContainer">
    <h2 id="cardTitle"></h2>
    <div id="bingoCard" class="bingo-card"></div>
    <div id="cardTimestamp"></div>
</div>

<div id="footer-placeholder"></div>

<script>
async function setupHeaderFile() {
    if (window.location.pathname.includes('admin')) {
        await setupHeader('header-admin.html');
    } else {
        await setupHeader('header-user.html');
    }
}

setupHeaderFile();

// bingo ロジック
const generateBtn = document.getElementById('generateBtn');
const shareBtn = document.getElementById('shareBtn');
const bingoCard = document.getElementById('bingoCard');
const cardTitle = document.getElementById('cardTitle');
const cardTimestamp = document.getElementById('cardTimestamp');
const playerName = document.getElementById('playerName');

let intervalId = null;
let currentNumbers = [];

// 1〜9のシャッフル
function shuffleNumbers() {
    const arr = [1,2,3,4,5,6,7,8,9];
    for (let i = arr.length -1; i>0; i--) {
        const j = Math.floor(Math.random()* (i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

// bingoカードを描画
function renderCard(numbers) {
    bingoCard.innerHTML = '';
    numbers.forEach(num => {
        const cell = document.createElement('div');
        cell.className = 'bingo-cell';
        cell.textContent = num;
        bingoCard.appendChild(cell);
    });
}

// 抽選開始/停止
generateBtn.addEventListener('click', () => {
    if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
        generateBtn.textContent = '抽選開始 / 停止';
        currentNumbers = shuffleNumbers();
        renderCard(currentNumbers);

        // タイトルとタイムスタンプ更新
        const name = playerName.value.trim() || '匿名';
        cardTitle.textContent = `${name}のビンゴカード`;
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth()+1).padStart(2,'0');
        const dd = String(now.getDate()).padStart(2,'0');
        const hh = String(now.getHours()).padStart(2,'0');
        const min = String(now.getMinutes()).padStart(2,'0');
        cardTimestamp.textContent = `${yyyy}/${mm}/${dd} ${hh}:${min}`;
    } else {
        // 抽選中
        intervalId = setInterval(() => {
            const nums = shuffleNumbers();
            renderCard(nums);
        }, 80);
        generateBtn.textContent = '抽選中... もう一度押すと停止';
    }
});

// 共有ボタン
shareBtn.addEventListener('click', async () => {
    html2canvas(document.getElementById('bingoCardContainer')).then(canvas => {
        canvas.toBlob(async blob => {
            const filesArray = [new File([blob], "bingo-card.png", {type: blob.type})];
            if (navigator.canShare && navigator.canShare({ files: filesArray })) {
                try {
                    await navigator.share({
                        files: filesArray,
                        title: cardTitle.textContent,
                        text: 'ビンゴカードを共有します'
                    });
                } catch (err) {
                    alert('共有に失敗しました: ' + err);
                }
            } else {
                // ダウンロードとして提供
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bingo-card.png';
                a.click();
                URL.revokeObjectURL(url);
            }
        });
    });
});
</script>
</body>
</html>