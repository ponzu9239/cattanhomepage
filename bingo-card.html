<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>きゃたんのAPEXビンゴ</title>
<link rel="stylesheet" href="common.css">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <section class="bingo-card-section">
      <h1 class="page-title">APEXビンゴ 🎯</h1>
      <h2 id="cardTitle">ビンゴカード</h2>

      <div id="bingoCard" class="bingo-card"></div>

      <div class="timestamp" id="cardTimestamp"></div>
    </section>
    
    <input type="text" id="playerName" placeholder="名前を入力">

    <div class="buttons">
      <button id="startStopBtn">抽選開始</button>
      <button id="shareBtn">ビンゴカードを共有</button>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script src="common.js"></script>
  <script>
    // ヘッダー読み込み
    setupHeader('header-user.html');

    // Firebase 初期化
    const firebaseConfig = {
      apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
      authDomain: "catiffanygame.firebaseapp.com",
      databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
      projectId: "catiffanygame",
      storageBucket: "catiffanygame.firebasestorage.app",
      messagingSenderId: "166871605809",
      appId: "1:166871605809:web:1fe6e874fa06005ec46b10",
      measurementId: "G-ZNGEZZWMTP"
    };
    firebase.initializeApp(firebaseConfig);
    const bingoCardRef = firebase.database().ref('bingoCard');

    const bingoCard = document.getElementById('bingoCard');
    const startStopBtn = document.getElementById('startStopBtn');
    const shareBtn = document.getElementById('shareBtn');
    const playerNameInput = document.getElementById('playerName');
    const cardTitle = document.getElementById('cardTitle');
    const cardTimestamp = document.getElementById('cardTimestamp');

    let intervalId = null;
    let currentNumbers = [];

    // 3x3セル生成
    function createCells() {
      bingoCard.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement('div');
        bingoCard.appendChild(cell);
      }
    }

    // ランダム数字生成
    function shuffleNumbers() {
      return [...Array(9)].map((_, i) => i + 1).sort(() => Math.random() - 0.5);
    }

    // 高速で数字を入れ替える
    function startShuffle() {
      intervalId = setInterval(() => {
        currentNumbers = shuffleNumbers();
        bingoCard.querySelectorAll('div').forEach((cell, i) => {
          cell.textContent = currentNumbers[i];
        });
      }, 50);
    }

    // 停止
    function stopShuffle() {
      clearInterval(intervalId);
      intervalId = null;

      const name = playerNameInput.value.trim();
      cardTitle.textContent = name ? `${name}のカード` : 'ビンゴカード';

      const now = new Date();
      const formatted = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      cardTimestamp.textContent = formatted;

      bingoCardRef.set({
        numbers: currentNumbers,
        playerName: name,
        timestamp: formatted
      });
    }

    // 名前入力でタイトルをリアルタイム更新
    playerNameInput.addEventListener('input', () => {
      const name = playerNameInput.value.trim();
      cardTitle.textContent = name ? `${name}のカード` : 'ビンゴカード';
    });

    // 開始/停止ボタン
    startStopBtn.addEventListener('click', () => {
      if (intervalId) {
        stopShuffle();
        startStopBtn.textContent = '抽選開始';
      } else {
        startShuffle();
        startStopBtn.textContent = '停止';
      }
    });

    // 共有ボタン
    shareBtn.addEventListener('click', async () => {
      const element = document.querySelector('.bingo-card-section');
      const canvas = await html2canvas(element);
      canvas.toBlob(async (blob) => {
        const file = new File([blob], "bingo-card.png", {type: blob.type});
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          try {
            await navigator.share({ files: [file], title: cardTitle.textContent, text: 'ビンゴカードを共有します' });
          } catch (err) {
            alert('共有に失敗しました: ' + err);
          }
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'bingo-card.png';
          a.click();
          URL.revokeObjectURL(url);
        }
      });
    });

    // 初期化
    createCells();
  </script>
</body>
</html>