<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>きゃたん 管理者ページ</title>
  <style>
    body {
      font-family: "Hiragino Maru Gothic ProN", sans-serif;
      background-color: #fff9f9;
      padding: 2rem;
      max-width: 700px;
      margin: auto;
      color: #333;
    }
    h1 { text-align: center; color: #97EADB; }
    label, input, button {
      display: block;
      margin: 0.5rem 0;
      width: 100%;
    }
    button {
      background: #97EADB;
      color: white;
      border: none;
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
    }
    button:hover { background: #7fcbd5; }
    button.danger { background: #f66; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #97EADB; padding: 0.5rem; text-align: center; }
    canvas { display: block; margin: 1rem auto; background: white; border-radius: 50%; }
    
      /* 既存のstyleの最後に追記 */
  #participantsTable input[type="text"],
  #participantsTable input[type="number"] {
    width: 90%;
    padding: 4px 6px;
    font-size: 0.9rem;
    box-sizing: border-box;
    height: 30px;  /* 高さを統一 */
    margin: 0;
  }

  #participantsTable td {
    padding: 4px;
    vertical-align: middle; /* 上下中央揃え */
  }

  #participantsTable td:nth-child(2) input {
    width: 60px; /* 倍率入力欄だけ狭め */
  }

  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
  <h1>きゃたん 管理者ページ</h1>

  <label>参加型コード：</label>
  <input type="text" id="participantCode" placeholder="コードを入力してください" />
  <label>配信中のURL：</label>
  <input type="text" id="streamUrl" placeholder="https://www.youtube.com/live/..." />
  <button onclick="saveData()">保存</button>

  <h2>🎰 ルーレット管理（倍率対応）</h2>
  <table id="participantsTable">
    <thead>
      <tr><th>参加者名</th><th>倍率</th><th>削除</th></tr>
    </thead>
    <tbody id="participantsTbody"></tbody>
  </table>
  <button onclick="addParticipantRow()">参加者を追加</button>
  <button id="spinStopButton" onclick="spinStopToggle()">ルーレットを回す</button>
  <button onclick="resetRoulette()" class="danger">リセット</button>

  <canvas id="rouletteCanvas" width="400" height="400"></canvas>
  <p id="rouletteStatus"></p>

  <script>
    // Firebase設定
    const firebaseConfig = {
      apiKey: "AIzaSyBWaCw2nAEh6FbYbteNk_fBSqPBTZ_UhC8",
      authDomain: "catiffanygame.firebaseapp.com",
      databaseURL: "https://catiffanygame-default-rtdb.firebaseio.com",
      projectId: "catiffanygame",
      storageBucket: "catiffanygame.appspot.com",
      messagingSenderId: "166871605809",
      appId: "1:166871605809:web:1fe6e874fa06005ec46b10"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const canvas = document.getElementById("rouletteCanvas");
    const ctx = canvas.getContext("2d");

    // かわいいパステルカラー
    function pastelColor(i) {
      const colors = ["#FFB3BA", "#FFDFBA", "#FFFFBA", "#BAFFC9", "#BAE1FF", "#E3BAFF"];
      return colors[i % colors.length];
    }

    window.onload = () => {
      db.ref("/cattan").once("value").then(snap => {
        const data = snap.val() || {};
        document.getElementById("participantCode").value = data.code || "";
        document.getElementById("streamUrl").value = data.stream || "";
      });
      db.ref("/roulette/participants").once("value").then(snap => {
        const data = snap.val() || [];
        if (data.length === 0) addParticipantRow();
        else data.forEach(p => addParticipantRow(p.name, p.multiplier));
        drawRoulette(data);
      });
    };

    function saveData() {
      db.ref("/cattan").set({
        code: document.getElementById("participantCode").value.trim() || "現在、参加型カスタムは行われておりません。",
        stream: document.getElementById("streamUrl").value.trim() || "現在、配信は行われていません。"
      });
    }

    function addParticipantRow(name = "", multiplier = 1) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text" value="${name}" placeholder="名前" oninput="saveParticipantsAuto()"></td>
        <td><input type="number" min="1" value="${multiplier}" oninput="saveParticipantsAuto()"></td>
        <td><button onclick="this.closest('tr').remove(); saveParticipantsAuto()">削除</button></td>
      `;
      document.getElementById("participantsTbody").appendChild(tr);
    }

    function saveParticipantsAuto() {
      const rows = document.querySelectorAll("#participantsTbody tr");
      const participants = [];
      rows.forEach(r => {
        const name = r.cells[0].querySelector("input").value.trim();
        let m = parseInt(r.cells[1].querySelector("input").value);
        if (!name) return;
        if (isNaN(m) || m < 1) m = 1;
        participants.push({ name, multiplier: m });
      });
      db.ref("/roulette/participants").set(participants);
      drawRoulette(participants);
    }

    function drawRoulette(participants) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (participants.length === 0) return;

      const totalWeight = participants.reduce((sum, p) => sum + p.multiplier, 0);
      let startAngle = 0;
      const segments = [];

      ctx.save();
      ctx.translate(canvas.width / 2, canvas.height / 2);

      participants.forEach((p, i) => {
        const angle = (2 * Math.PI) * (p.multiplier / totalWeight);
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.arc(0, 0, 180, startAngle, startAngle + angle);
        ctx.fillStyle = pastelColor(i);
        ctx.fill();
        ctx.stroke();

        ctx.save();
        ctx.rotate(startAngle + angle / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#333";
        ctx.font = "14px sans-serif";
        ctx.fillText(p.name, 160, 5);
        ctx.restore();

        segments.push({ name: p.name, startAngle, endAngle: startAngle + angle });
        startAngle += angle;
      });

      ctx.restore();
      db.ref("/roulette/segments").set(segments); // 🔹 リアルタイム共有
    }

    // ===== ルーレット回転＆当選処理 =====
    let spinning = false;
    let intervalId = null;
    function spinStopToggle() {
      const button = document.getElementById("spinStopButton");
      const statusEl = document.getElementById("rouletteStatus");

      if (!spinning) {
        spinning = true;
        button.textContent = "停止";
        db.ref("/roulette/status").set("spinning");

        intervalId = setInterval(() => {
          ctx.translate(canvas.width / 2, canvas.height / 2);
          ctx.rotate(0.2); // 高速回転
          ctx.translate(-canvas.width / 2, -canvas.height / 2);
          db.ref("/roulette/spinAngle").set(Date.now()); // 回転同期用
        }, 50);

      } else {
        spinning = false;
        button.textContent = "ルーレットを回す";
        clearInterval(intervalId);
        intervalId = null;

        db.ref("/roulette/status").set("stopped");

        // 当選者を角度から決定
        db.ref("/roulette/segments").once("value").then(snap => {
          const segments = snap.val();
          if (!segments) return;

          const random = Math.random() * 2 * Math.PI;
          const winner = segments.find(s => random >= s.startAngle && random < s.endAngle)?.name || "未決定";

          statusEl.textContent = `🎉 当選者: ${winner}`;
          db.ref(`/roulette/winner/${Date.now()}`).set(winner);
        });
      }
    }

    function resetRoulette() {
      db.ref("/roulette/participants").remove();
      db.ref("/roulette/winner").remove();
      db.ref("/roulette/segments").remove();
      document.getElementById("participantsTbody").innerHTML = "";
      addParticipantRow();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  </script>
</body>
</html>